<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash-Plus Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Mobile optimizations */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent text size adjustments on mobile */
        body {
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* Better touch targets on mobile */
        @media (max-width: 768px) {
            button, a, input, textarea {
                min-height: 44px;
            }

            /* Reserve space for bottom nav */
            #mainContent {
                padding-bottom: 64px;
            }

            /* Ensure task table doesn't overflow behind bottom nav */
            #taskTable {
                padding-bottom: 80px;
            }
        }

        /* Swipe gesture styles (mobile only) */
        @media (max-width: 768px) {
            .task-row-wrapper {
                position: relative;
                overflow: hidden;
            }

            .task-row {
                position: relative;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 2;
            }

            .task-row.swiping {
                transition: none;
            }

            .swipe-actions {
                position: absolute;
                top: 0;
                bottom: 0;
                display: flex;
                align-items: stretch;
                z-index: 1;
            }

            .swipe-actions-left {
                left: 0;
                justify-content: flex-start;
            }

            .swipe-actions-right {
                right: 0;
                justify-content: flex-end;
            }

            .swipe-action {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                width: 60px;
                border: none;
                font-size: 11px;
                font-weight: 600;
                color: white;
                cursor: pointer;
                transition: opacity 0.2s;
            }

            .swipe-action svg {
                width: 20px;
                height: 20px;
            }

            .swipe-action-done {
                background: #10b981;
            }

            .swipe-action-delete {
                background: #ef4444;
            }

            .swipe-action-more {
                background: #6b7280;
            }

            .swipe-action-status {
                background: #3b82f6;
                width: 80px;
            }

            .swipe-action:active {
                opacity: 0.8;
            }
        }

        /* === PHASE 6: ACCESSIBILITY (WCAG 2.1 AA) === */

        /* Focus indicators with proper contrast (WCAG requirement) */
        *:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .dark *:focus {
            outline-color: #60a5fa;
        }

        *:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .dark *:focus-visible {
            outline-color: #60a5fa;
        }

        /* Skip links for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 100;
            border-radius: 0 0 4px 0;
            font-weight: 600;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Loading skeleton animation */
        @keyframes skeleton-loading {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 0px, #e0e0e0 40px, #f0f0f0 80px);
            background-size: 200px 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #374151 0px, #4b5563 40px, #374151 80px);
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Error states with WCAG AA contrast */
        .error-border {
            border: 2px solid #dc2626 !important;
        }

        .error-text {
            color: #dc2626;
            font-weight: 500;
        }

        .dark .error-text {
            color: #f87171;
        }

        .error-bg {
            background-color: #fee2e2;
        }

        .dark .error-bg {
            background-color: #7f1d1d;
        }

        /* Loading spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Respect user's motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .skeleton,
            .spinner {
                animation: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Skip Links for Keyboard Navigation -->
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <a href="#taskTable" class="skip-link">Skip to task list</a>
    <a href="#bottomNav" class="skip-link md:hidden">Skip to navigation</a>

    <!-- Live Region for Screen Reader Announcements -->
    <div id="announcements" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <div class="h-screen flex flex-col">
        <!-- Mobile Header (< 768px) -->
        <header class="md:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700" role="banner">
            <div class="flex items-center justify-between h-14 px-4">
                <!-- Left: Hamburger -->
                <button onclick="toggleHamburgerMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" aria-label="Open menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <!-- Center: Logo + Project -->
                <div class="flex items-center gap-2">
                    <h1 class="text-base font-bold text-blue-600 dark:text-blue-400">dash-plus</h1>
                    <button onclick="toggleProjectSelector()" id="currentProjectBtn" class="px-2 py-1 text-sm bg-gray-100 dark:bg-gray-700 rounded flex items-center gap-1" aria-label="Select project" aria-haspopup="true">
                        <span id="currentProjectName">Inbox</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Right: Settings -->
                <button onclick="toggleMobileSettings()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" aria-label="Open settings">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Desktop Header (‚â• 768px) -->
        <header class="hidden md:block bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-3" role="banner">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-blue-600 dark:text-blue-400">dash-plus</h1>
                    <div id="projectTabs" class="flex gap-2"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="terminologyToggle" class="px-3 py-2 text-xs font-mono bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg" aria-label="Toggle terminology between Dash-Plus and 5D">
                        <span id="termLabel">-+</span>
                    </button>
                    <button id="themeToggle" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" aria-label="Toggle dark mode">
                        <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                    <button id="newProjectBtn" class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg" aria-label="Create new project">
                        + Project
                    </button>
                    <div class="relative">
                        <button onclick="toggleExportMenu()" id="exportMenuBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-400" aria-label="Export options" aria-haspopup="true">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                        </button>
                        <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                            <button onclick="exportMarkdown()" class="w-full px-4 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 rounded-t-lg" aria-label="Export as Markdown">
                                üìù Export Markdown
                            </button>
                            <button onclick="exportPDF()" class="w-full px-4 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 rounded-b-lg" aria-label="Export as PDF">
                                üìÑ Export PDF
                            </button>
                        </div>
                    </div>
                    <button onclick="toggleKeyboardHelp()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-400" aria-label="Show keyboard shortcuts">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="mainContent" class="flex-1 flex flex-col lg:flex-row overflow-hidden relative" role="main">
            <!-- Left Sidebar (Desktop ‚â• 1024px) -->
            <aside id="leftSidebar" class="hidden lg:flex lg:w-60 flex-col bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700">
                <!-- Project List -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Projects</h3>
                        <div id="sidebarProjectList" class="space-y-1"></div>
                    </div>

                    <!-- View Switcher -->
                    <div class="mb-6">
                        <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Views</h3>
                        <div class="space-y-1">
                            <button onclick="switchToListView()" id="sidebarViewTasks" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-800 flex items-center gap-2">
                                <span>‚ò∞</span> Tasks
                            </button>
                            <button onclick="switchToMatrixView()" id="sidebarViewMatrix" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-800 flex items-center gap-2">
                                <span>‚äû</span> Matrix
                            </button>
                            <button onclick="switchToRaidView()" id="sidebarViewRaid" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-800 flex items-center gap-2">
                                <span>‚ö†</span> RAID
                            </button>
                            <button onclick="toggleArchivedView()" id="sidebarViewArchived" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-800 flex items-center gap-2">
                                <span>üóÑ</span> Archived
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="border-t border-gray-200 dark:border-gray-700 p-4">
                    <button id="sidebarTerminologyToggle" class="w-full px-3 py-2 text-xs font-mono bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 rounded text-left" title="Toggle terminology">
                        <span id="sidebarTermLabel">-+</span> Terminology
                    </button>
                    <button id="sidebarThemeToggle" class="w-full mt-2 px-3 py-2 text-sm bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 rounded text-left" title="Toggle theme">
                        <span class="inline dark:hidden">‚òÄÔ∏è Light</span>
                        <span class="hidden dark:inline">üåô Dark</span>
                    </button>
                </div>
            </aside>

            <!-- Center Column (Task List) -->
            <div id="mainContent" class="w-full lg:flex-1 flex flex-col bg-white dark:bg-gray-800 transition-all duration-300 ease-in-out">
                <!-- Bulk Actions Toolbar (shown when items selected) -->
                <div id="bulkActionsToolbar" class="hidden px-4 py-2 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-200 dark:border-blue-800">
                    <div class="flex items-center justify-between">
                        <span id="selectedCount" class="text-sm font-medium text-blue-700 dark:text-blue-300">0 selected</span>
                        <div class="flex gap-2">
                            <button onclick="bulkMarkDone()" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded">
                                Mark Done
                            </button>
                            <button onclick="bulkArchive()" class="px-3 py-1 text-xs bg-gray-600 hover:bg-gray-700 text-white rounded">
                                Archive
                            </button>
                            <button onclick="clearSelection()" class="px-3 py-1 text-xs bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 rounded">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                    <input
                        id="searchInput"
                        type="text"
                        placeholder="üîç Search tasks..."
                        oninput="handleSearch(this.value)"
                        class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                    />
                </div>

                <!-- View Filter -->
                <div id="viewFilter" class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:border-gray-900/50"></div>

                <!-- Table Header -->
                <div class="hidden lg:block px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                    <div class="grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                        <div class="col-span-1 flex items-center">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()" class="w-4 h-4 rounded border-gray-300 dark:border-gray-600" title="Select all">
                        </div>
                        <div class="col-span-6">Task</div>
                        <div class="col-span-2">Status</div>
                        <div class="col-span-2">Due Date</div>
                        <div class="col-span-1">Actions</div>
                    </div>
                </div>

                <!-- Table Header (Mobile/Tablet without checkbox) -->
                <div class="block lg:hidden md:block px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                    <div class="grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">
                        <div class="col-span-1">Status</div>
                        <div class="col-span-7">Task</div>
                        <div class="col-span-3">Due Date</div>
                        <div class="col-span-1">Actions</div>
                    </div>
                </div>

                <!-- Task Rows -->
                <div id="taskTable" class="flex-1 overflow-y-auto"></div>

                <!-- Eisenhower Matrix View -->
                <div id="matrixView" class="hidden flex-1 overflow-y-auto p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
                        <!-- Urgent & Important -->
                        <div class="border-2 border-red-300 dark:border-red-700 rounded-lg p-4 bg-red-50/50 dark:bg-red-950/20">
                            <h3 class="text-sm font-semibold mb-3 text-red-700 dark:text-red-300 flex items-center gap-2">
                                <span>üî¥</span> Urgent & Important
                            </h3>
                            <div id="matrix-urgent-important" class="space-y-2"></div>
                        </div>

                        <!-- Not Urgent & Important -->
                        <div class="border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4 bg-blue-50/50 dark:bg-blue-950/20">
                            <h3 class="text-sm font-semibold mb-3 text-blue-700 dark:text-blue-300 flex items-center gap-2">
                                <span>üìÖ</span> Not Urgent & Important
                            </h3>
                            <div id="matrix-noturgent-important" class="space-y-2"></div>
                        </div>

                        <!-- Urgent & Not Important -->
                        <div class="border-2 border-yellow-300 dark:border-yellow-700 rounded-lg p-4 bg-yellow-50/50 dark:bg-yellow-950/20">
                            <h3 class="text-sm font-semibold mb-3 text-yellow-700 dark:text-yellow-300 flex items-center gap-2">
                                <span>‚ö°</span> Urgent & Not Important
                            </h3>
                            <div id="matrix-urgent-notimportant" class="space-y-2"></div>
                        </div>

                        <!-- Not Urgent & Not Important -->
                        <div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50/50 dark:bg-gray-800/20">
                            <h3 class="text-sm font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center gap-2">
                                <span>üìù</span> Not Urgent & Not Important
                            </h3>
                            <div id="matrix-noturgent-notimportant" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- RAID Log View -->
                <div id="raidView" class="hidden flex-1 overflow-y-auto p-4">
                    <!-- Risk Matrix -->
                    <div class="mb-6 p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center gap-2">
                            <span>‚ö†Ô∏è</span> Risk Matrix
                            <span class="text-xs font-normal text-gray-500 dark:text-gray-400">(Likelihood √ó Impact)</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse text-xs">
                                <thead>
                                    <tr>
                                        <th class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 w-24"></th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 font-semibold">Low Likelihood</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 font-semibold">Medium Likelihood</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 font-semibold">High Likelihood</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 font-semibold">High Impact</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-orange-100 dark:bg-orange-950/30 align-top" id="risk-matrix-low-high"></td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-red-200 dark:bg-red-900/40 align-top" id="risk-matrix-medium-high"></td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-red-300 dark:bg-red-800/50 align-top" id="risk-matrix-high-high"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 font-semibold">Medium Impact</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-yellow-100 dark:bg-yellow-950/30 align-top" id="risk-matrix-low-medium"></td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-orange-100 dark:bg-orange-950/30 align-top" id="risk-matrix-medium-medium"></td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-red-200 dark:bg-red-900/40 align-top" id="risk-matrix-high-medium"></td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-gray-50 dark:bg-gray-900 font-semibold">Low Impact</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-green-100 dark:bg-green-950/30 align-top" id="risk-matrix-low-low"></td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-yellow-100 dark:bg-yellow-950/30 align-top" id="risk-matrix-medium-low"></td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2 bg-orange-100 dark:bg-orange-950/30 align-top" id="risk-matrix-high-low"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Risks -->
                        <div class="border-2 border-red-300 dark:border-red-700 rounded-lg p-4 bg-red-50/50 dark:bg-red-950/20">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-semibold text-red-700 dark:text-red-300 flex items-center gap-2">
                                    <span>‚ö†Ô∏è</span> Risks
                                </h3>
                                <button onclick="createNewRaidItem('risk')" class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 rounded">
                                    + Risk
                                </button>
                            </div>
                            <div id="raid-risks" class="space-y-2"></div>
                        </div>

                        <!-- Assumptions -->
                        <div class="border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4 bg-blue-50/50 dark:bg-blue-950/20">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-semibold text-blue-700 dark:text-blue-300 flex items-center gap-2">
                                    <span>üí≠</span> Assumptions
                                </h3>
                                <button onclick="createNewRaidItem('assumption')" class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 rounded">
                                    + Assumption
                                </button>
                            </div>
                            <div id="raid-assumptions" class="space-y-2"></div>
                        </div>

                        <!-- Issues -->
                        <div class="border-2 border-orange-300 dark:border-orange-700 rounded-lg p-4 bg-orange-50/50 dark:bg-orange-950/20">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-semibold text-orange-700 dark:text-orange-300 flex items-center gap-2">
                                    <span>üö®</span> Issues
                                </h3>
                                <button onclick="createNewRaidItem('issue')" class="px-2 py-1 text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-800 rounded">
                                    + Issue
                                </button>
                            </div>
                            <div id="raid-issues" class="space-y-2"></div>
                        </div>

                        <!-- Dependencies -->
                        <div class="border-2 border-purple-300 dark:border-purple-700 rounded-lg p-4 bg-purple-50/50 dark:bg-purple-950/20">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-semibold text-purple-700 dark:text-purple-300 flex items-center gap-2">
                                    <span>üîó</span> Dependencies
                                </h3>
                                <button onclick="createNewRaidItem('dependency')" class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 rounded">
                                    + Dependency
                                </button>
                            </div>
                            <div id="raid-dependencies" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Link Task Overlay -->
            <div id="linkOverlay" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onclick="if(event.target.id==='linkOverlay') cancelLinking()">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 max-w-2xl w-full max-h-[90vh] md:max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-semibold">Link Task</h2>
                            <button onclick="cancelLinking()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-600 dark:text-gray-400 block mb-2">Link type:</label>
                                <div id="linkTypeSelector" class="flex gap-2 flex-wrap"></div>
                            </div>
                            <input
                                id="linkSearchInput"
                                type="text"
                                placeholder="Search tasks..."
                                class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500"
                                oninput="filterLinkTasks(this.value)"
                            />
                        </div>
                    </div>
                    <div id="linkTaskList" class="flex-1 overflow-y-auto p-6">
                    </div>
                </div>
            </div>

            <!-- Type Selector Floating Panel -->
            <div id="typeSelectorPanel" class="hidden fixed z-50 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 w-64 max-w-[90vw]">
                <div class="p-2 space-y-1">
                    <button onclick="setNewTaskType('task')" id="typeBtn-task" class="w-full px-4 py-3 text-left rounded-lg bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900 transition-colors flex items-center gap-2">
                        <span class="text-lg">üìù</span>
                        <div>
                            <div class="font-medium">Task</div>
                            <div class="text-xs opacity-75">Regular to-do item</div>
                        </div>
                    </button>
                    <button onclick="setNewTaskType('risk')" id="typeBtn-risk" class="w-full px-4 py-3 text-left rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-2">
                        <span class="text-lg">‚ö†Ô∏è</span>
                        <div>
                            <div class="font-medium">Risk</div>
                            <div class="text-xs opacity-75">Potential problem to monitor</div>
                        </div>
                    </button>
                    <button onclick="setNewTaskType('assumption')" id="typeBtn-assumption" class="w-full px-4 py-3 text-left rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-2">
                        <span class="text-lg">üí≠</span>
                        <div>
                            <div class="font-medium">Assumption</div>
                            <div class="text-xs opacity-75">Premise that needs validation</div>
                        </div>
                    </button>
                    <button onclick="setNewTaskType('issue')" id="typeBtn-issue" class="w-full px-4 py-3 text-left rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-2">
                        <span class="text-lg">üö®</span>
                        <div>
                            <div class="font-medium">Issue</div>
                            <div class="text-xs opacity-75">Active problem to resolve</div>
                        </div>
                    </button>
                    <button onclick="setNewTaskType('dependency')" id="typeBtn-dependency" class="w-full px-4 py-3 text-left rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-2">
                        <span class="text-lg">üîó</span>
                        <div>
                            <div class="font-medium">Dependency</div>
                            <div class="text-xs opacity-75">External requirement</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Keyboard Shortcuts Overlay -->
            <div id="keyboardHelp" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onclick="if(event.target.id==='keyboardHelp') toggleKeyboardHelp()">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 max-w-2xl w-full max-h-[90vh] md:max-h-[80vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Keyboard Shortcuts</h2>
                        <button onclick="toggleKeyboardHelp()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-6">
                        <!-- System Explanation -->
                        <div class="bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-blue-900 dark:text-blue-300 mb-2">üìö Task Management Systems</h3>
                            <div class="space-y-3 text-sm text-blue-800 dark:text-blue-200">
                                <div>
                                    <strong class="font-mono">Dash-Plus (-+)</strong>
                                    <p class="text-xs mt-1">Symbol-based workflow with inline status indicators:</p>
                                    <ul class="text-xs mt-1 ml-4 space-y-1">
                                        <li><span class="font-mono">-</span> Active (working on it)</li>
                                        <li><span class="font-mono">‚Üí</span> Waiting (blocked by external factor)</li>
                                        <li><span class="font-mono">‚Üê</span> Delegated (assigned to someone else)</li>
                                        <li><span class="font-mono">‚ñ≥</span> Reference (for later review)</li>
                                        <li><span class="font-mono">‚óã</span> Done (completed)</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong class="font-mono">5D System</strong>
                                    <p class="text-xs mt-1">Alternative terminology for the same statuses:</p>
                                    <ul class="text-xs mt-1 ml-4 space-y-1">
                                        <li><strong>Do</strong> - Tasks you're actively working on</li>
                                        <li><strong>Defer</strong> - Waiting on something/someone</li>
                                        <li><strong>Delegate</strong> - Assigned to another person</li>
                                        <li><strong>Designate</strong> - Reference material</li>
                                        <li><strong>Done</strong> - Completed tasks</li>
                                    </ul>
                                </div>
                                <p class="text-xs italic">Toggle between systems using the <kbd class="px-1 py-0.5 bg-blue-200 dark:bg-blue-900 rounded font-mono">-+</kbd> or <kbd class="px-1 py-0.5 bg-blue-200 dark:bg-blue-900 rounded font-mono">5D</kbd> button in the header.</p>
                            </div>
                        </div>

                        <!-- Keyboard Shortcuts -->
                        <div>
                            <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase mb-3">Navigation</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Move up/down</span>
                                    <div class="flex gap-2">
                                        <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">‚Üë</kbd>
                                        <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">‚Üì</kbd>
                                        <span class="text-gray-400">or</span>
                                        <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">j</kbd>
                                        <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">k</kbd>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Clear selection</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Esc</kbd>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase mb-3">Task Actions</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">New task</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">n</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Edit selected task</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Enter</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Toggle done/active (+/- or Done/Do)</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">d</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="text-sm">
                                        <div>Cycle status</div>
                                        <div class="text-xs text-gray-500">-+ : - ‚Üí ‚Üí ‚Üê ‚ñ≥ ‚óã</div>
                                        <div class="text-xs text-gray-500">5D: Do ‚Üí Defer ‚Üí Delegate ‚Üí Designate ‚Üí Done</div>
                                    </div>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">s</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Archive task</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Delete</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Undo</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Ctrl/Cmd+Z</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Redo</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Ctrl/Cmd+Y</kbd>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase mb-3">Editing</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Edit any field inline</span>
                                    <span class="text-sm text-gray-500">Double-click</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Save changes</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Enter</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Cancel editing</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">Esc</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Reorder tasks</span>
                                    <span class="text-sm text-gray-500">Drag ‚†ø handle</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 uppercase mb-3">Other</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Show this help</span>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-sm font-mono">?</kbd>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm">Rename project</span>
                                    <span class="text-sm text-gray-500">Right-click project tab</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Action Bar -->
            <div id="actionBar" class="hidden fixed bottom-4 md:bottom-6 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 shadow-2xl rounded-xl border border-gray-200 dark:border-gray-700 px-2 py-2 flex gap-1 z-50 max-w-[95vw]">
                <button onclick="editSelectedTask()" class="px-3 md:px-4 py-3 md:py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-xs md:text-sm flex items-center gap-2 min-h-[44px]">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    <span class="hidden sm:inline">Edit</span>
                </button>
                <button onclick="cycleSelectedStatus()" class="px-3 md:px-4 py-3 md:py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-xs md:text-sm flex items-center gap-2 min-h-[44px]">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <span class="hidden sm:inline">Status</span>
                </button>
                <button onclick="toggleSelectedDone()" class="px-3 md:px-4 py-3 md:py-2 hover:bg-green-50 dark:hover:bg-green-900/20 text-green-600 dark:text-green-400 rounded-lg text-xs md:text-sm flex items-center gap-2 min-h-[44px]">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="hidden sm:inline">Done</span>
                </button>
                <button onclick="deleteSelectedTask()" class="px-3 md:px-4 py-3 md:py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg text-xs md:text-sm flex items-center gap-2 min-h-[44px]">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span class="hidden sm:inline">Delete</span>
                </button>
            </div>

            <!-- Floating Details Toggle (visible when collapsed) -->
            <button id="floatingDetailsToggle" class="hidden fixed right-0 top-1/2 transform -translate-y-1/2 bg-white dark:bg-gray-800 border-l border-t border-b border-gray-200 dark:border-gray-700 rounded-l-lg px-2 py-6 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-lg z-40 transition-all duration-300" onclick="toggleDetails()" title="Show details panel">
                <span class="text-gray-600 dark:text-gray-400 text-lg">‚óÄ</span>
            </button>

            <!-- Mobile Bottom Sheet Backdrop -->
            <div id="detailsBackdrop" class="md:hidden fixed inset-0 bg-black transition-opacity duration-300 pointer-events-none opacity-0 z-20" onclick="closeBottomSheet()"></div>

            <!-- Details Panel -->
            <div id="detailsPanelContainer" class="fixed bottom-0 left-0 right-0 lg:relative lg:top-0 lg:bottom-0 w-full lg:w-90 h-[60vh] lg:h-auto flex flex-col bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 lg:border-l lg:border-t-0 rounded-t-2xl lg:rounded-none z-30 lg:shadow-none" style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
                <!-- Mobile Bottom Sheet Handle -->
                <div id="bottomSheetHandle" class="md:hidden flex justify-center pt-2 pb-1 cursor-grab active:cursor-grabbing" style="touch-action: none;">
                    <div class="w-12 h-1 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                </div>
                <div class="px-6 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="toggleDetails()">
                    <h2 class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase">Details</h2>
                    <span id="detailsToggle" class="text-gray-400 dark:text-gray-500 transition-all duration-300">‚ñ∂</span>
                </div>
                <div id="detailsPanel" class="flex-1 overflow-y-auto p-6">
                </div>

                <!-- Keyboard Shortcuts - Always Visible -->
                <div class="border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-6 py-4">
                    <h3 class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-3">Keyboard Shortcuts</h3>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-xs">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Navigate</span>
                            <div class="flex gap-1">
                                <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">‚Üë‚Üì</kbd>
                                <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">jk</kbd>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Edit</span>
                            <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">Enter</kbd>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">New Task</span>
                            <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">n</kbd>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Toggle Done</span>
                            <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">d</kbd>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Cycle Status</span>
                            <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">s</kbd>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Delete</span>
                            <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">Del</kbd>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Clear Selection</span>
                            <kbd class="px-1.5 py-0.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono">Esc</kbd>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Edit inline</span>
                            <span class="text-xs text-gray-500">Double-click</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                        <div class="flex items-center gap-4 text-xs text-gray-600 dark:text-gray-400 flex-wrap">
                            <span><span class="font-mono">-</span> Active</span>
                            <span><span class="font-mono">‚Üí</span> Waiting</span>
                            <span><span class="font-mono">‚Üê</span> Delegated</span>
                            <span><span class="font-mono">‚ñ≥</span> Reference</span>
                            <span><span class="font-mono">‚óã</span> Done</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Hamburger Menu Drawer (Mobile) -->
        <div id="hamburgerMenu" class="md:hidden fixed inset-0 z-50 hidden">
            <!-- Overlay -->
            <div class="absolute inset-0 bg-black/50" onclick="toggleHamburgerMenu()"></div>

            <!-- Drawer -->
            <div class="absolute left-0 top-0 bottom-0 w-80 max-w-[85vw] bg-white dark:bg-gray-800 transform transition-transform duration-300" id="hamburgerDrawer" style="transform: translateX(-100%)">
                <div class="flex flex-col h-full">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-lg font-bold">Menu</h2>
                        <button onclick="toggleHamburgerMenu()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto">
                        <!-- Projects Section -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Projects</h3>
                            <div id="hamburgerProjectList" class="space-y-1"></div>
                            <button onclick="newProject()" class="w-full mt-2 px-3 py-2 text-left text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg">
                                + New Project
                            </button>
                        </div>

                        <!-- Views Section -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Views</h3>
                            <button id="hamburgerTaskView" onclick="setView('tasks'); toggleHamburgerMenu()" class="w-full px-3 py-2 text-left text-sm bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 rounded-lg mb-1">
                                üìù Task List
                            </button>
                            <button id="hamburgerMatrixView" onclick="setView('matrix'); toggleHamburgerMenu()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg mb-1">
                                üìä Matrix
                            </button>
                            <button id="hamburgerRaidView" onclick="setView('raid'); toggleHamburgerMenu()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg mb-1">
                                üéØ RAID
                            </button>
                            <button id="hamburgerArchivedView" onclick="toggleArchived(); toggleHamburgerMenu()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg flex items-center justify-between">
                                <span>üì¶ Archived</span>
                                <span id="hamburgerArchivedCount" class="text-xs text-gray-500">0</span>
                            </button>
                        </div>

                        <!-- Settings Section -->
                        <div class="p-4">
                            <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-2">Settings</h3>
                            <button onclick="toggleTheme()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg mb-1">
                                üåô Toggle Theme
                            </button>
                            <button onclick="toggleTerminology()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg mb-1">
                                -+ Toggle Terminology
                            </button>
                            <button onclick="toggleKeyboardHelp(); toggleHamburgerMenu()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg mb-1">
                                ‚å®Ô∏è Keyboard Shortcuts
                            </button>
                            <button onclick="exportMarkdown(); toggleHamburgerMenu()" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                                üì§ Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation (Mobile) -->
        <nav id="bottomNav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 z-40" role="navigation" aria-label="Main navigation">
            <div class="grid grid-cols-4 h-16">
                <button onclick="setBottomNavView('all')" data-nav="all" class="flex flex-col items-center justify-center gap-0.5 text-blue-600 dark:text-blue-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    <span class="text-xs">All</span>
                </button>
                <button onclick="setBottomNavView('active')" data-nav="active" class="flex flex-col items-center justify-center gap-0.5 text-gray-600 dark:text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-xs">Active</span>
                </button>
                <button onclick="setBottomNavView('matrix')" data-nav="matrix" class="flex flex-col items-center justify-center gap-0.5 text-gray-600 dark:text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                    </svg>
                    <span class="text-xs">Matrix</span>
                </button>
                <button onclick="setBottomNavView('more')" data-nav="more" class="flex flex-col items-center justify-center gap-0.5 text-gray-600 dark:text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                    <span class="text-xs">More</span>
                </button>
            </div>
        </nav>

        <!-- FAB (Floating Action Button) - Mobile -->
        <button id="fab" onclick="toggleFabMenu()" class="md:hidden fixed bottom-20 right-4 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center z-30 transition-all">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </button>

        <!-- FAB Menu (Type Selector) -->
        <div id="fabMenu" class="md:hidden fixed bottom-36 right-4 hidden z-30">
            <div class="flex flex-col items-end gap-2">
                <button onclick="createTaskWithType('task'); toggleFabMenu()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <span>üìù Task</span>
                </button>
                <button onclick="createTaskWithType('risk'); toggleFabMenu()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <span>‚ö†Ô∏è Risk</span>
                </button>
                <button onclick="createTaskWithType('assumption'); toggleFabMenu()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <span>üí≠ Assumption</span>
                </button>
                <button onclick="createTaskWithType('issue'); toggleFabMenu()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <span>üö® Issue</span>
                </button>
                <button onclick="createTaskWithType('dependency'); toggleFabMenu()" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                    <span>üîó Dependency</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        const state = {
            projects: {},
            currentProject: null,
            selectedIndex: -1,
            editingTaskId: null,
            editingField: null,
            editingProjectId: null,
            terminology: 'dashPlus', // 'dashPlus' or 'fiveD'
            showArchived: false,
            showMatrixView: false,
            showRaidView: false,
            suggestions: [],
            suggestionIndex: -1,
            viewFilter: 'all', // 'all', 'active', 'waiting', 'delegated', 'done', 'overdue'
            detailsExpanded: true,
            showKeyboardHelp: false,
            linkingMode: false,
            linkingSourceId: null,
            linkingType: 'relates-to',
            searchQuery: '',
            newTaskType: 'task',  // Selected type for new task creation
            showTypeSelector: false,  // Show/hide floating type selector
            history: [],
            historyIndex: -1,
            maxHistory: 50,
            // New UI state
            hamburgerMenuOpen: false,
            fabMenuOpen: false,
            bottomNavView: 'all', // 'all', 'active', 'matrix', 'more'
            projectSelectorOpen: false,
            mobileSettingsOpen: false,
            // Touch/swipe gesture tracking
            touchStartX: 0,
            touchStartY: 0,
            touchStartTime: 0,
            swipingTaskId: null,
            swipeDirection: null, // 'left' or 'right'
            // Mobile bottom sheet state (for details panel)
            bottomSheetState: 'collapsed', // 'collapsed', 'half', 'full'
            bottomSheetDragging: false,
            bottomSheetStartY: 0,
            bottomSheetCurrentY: 0,
            // Multi-select state
            selectedTaskIds: new Set()
        };

        const SYMBOLS = {
            active: '-',      // New task or undone action item
            done: '+',        // Task complete or cancelled
            waiting: '‚Üí',     // Waiting for next action
            delegated: '‚Üê',   // Delegated to new owner
            reference: 'Œî'    // Reference/data point (no longer actionable)
        };

        const LINK_TYPES = {
            'blocks': { label: 'Blocks', icon: 'üö´', color: 'red' },
            'blocked-by': { label: 'Blocked by', icon: '‚õî', color: 'red' },
            'relates-to': { label: 'Relates to', icon: 'üîó', color: 'blue' },
            'duplicate-of': { label: 'Duplicate of', icon: 'üìã', color: 'gray' },
            'parent-of': { label: 'Parent of', icon: '‚¨ÜÔ∏è', color: 'purple' },
            'child-of': { label: 'Child of', icon: '‚¨áÔ∏è', color: 'purple' }
        };

        const TERMINOLOGY = {
            dashPlus: {
                active: { label: 'Active', action: 'Mark active' },
                waiting: { label: 'Waiting', action: 'Mark waiting' },
                delegated: { label: 'Delegated', action: 'Delegate' },
                reference: { label: 'Reference', action: 'Mark reference' },
                done: { label: 'Done', action: 'Mark done' },
                archive: 'Archive',
                archived: 'Archived'
            },
            fiveD: {
                active: { label: 'Do', action: 'Do now' },
                waiting: { label: 'Defer', action: 'Defer' },
                delegated: { label: 'Delegate', action: 'Delegate' },
                reference: { label: 'Designate', action: 'Designate' },
                done: { label: 'Done', action: 'Done' },
                archive: 'Delete',
                archived: 'Deleted'
            }
        };

        function getTerm(status) {
            return TERMINOLOGY[state.terminology][status]?.label || status;
        }

        // Utility
        function id() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateReadableId(type) {
            const prefix = {
                task: 'TASK',
                risk: 'RISK',
                assumption: 'ASMP',
                issue: 'ISSU',
                dependency: 'DEPN'
            }[type] || 'TASK';

            // Count existing items of this type
            const allTasks = getProject().tasks;
            const count = allTasks.filter(t => t.type === type).length + 1;

            return `${prefix}-${String(count).padStart(3, '0')}`;
        }

        function parseDate(input) {
            if (!input) return null;
            const lower = input.toLowerCase().trim();
            const today = new Date();

            if (lower === 'today') return today;
            if (lower === 'tomorrow') {
                const d = new Date(today);
                d.setDate(d.getDate() + 1);
                return d;
            }
            if (lower === 'next week') {
                const d = new Date(today);
                d.setDate(d.getDate() + 7);
                return d;
            }
            if (/^\d{4}-\d{2}-\d{2}$/.test(input)) return new Date(input);

            const qMatch = lower.match(/q([1-4])\s*(\d{4})/);
            if (qMatch) {
                return new Date(parseInt(qMatch[2]), (parseInt(qMatch[1]) - 1) * 3, 1);
            }

            return null;
        }

        function formatDate(date) {
            if (!date) return '';
            return new Date(date).toISOString().split('T')[0];
        }

        function esc(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Data
        function saveToHistory() {
            // Create snapshot for undo
            const snapshot = JSON.parse(JSON.stringify({ projects: state.projects }));

            // Remove future history if we're not at the end
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }

            state.history.push(snapshot);

            // Limit history size
            if (state.history.length > state.maxHistory) {
                state.history.shift();
            } else {
                state.historyIndex++;
            }
        }

        function save() {
            saveToHistory();
            localStorage.setItem('dashPlus', JSON.stringify(state));
        }

        function undo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                const snapshot = state.history[state.historyIndex];
                state.projects = JSON.parse(JSON.stringify(snapshot.projects));
                localStorage.setItem('dashPlus', JSON.stringify(state));
                render();
            }
        }

        function redo() {
            if (state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                const snapshot = state.history[state.historyIndex];
                state.projects = JSON.parse(JSON.stringify(snapshot.projects));
                localStorage.setItem('dashPlus', JSON.stringify(state));
                render();
            }
        }

        function load() {
            const saved = localStorage.getItem('dashPlus');
            if (saved) {
                Object.assign(state, JSON.parse(saved));
                // Initialize history if empty
                if (!state.history || state.history.length === 0) {
                    state.history = [];
                    state.historyIndex = -1;
                    saveToHistory();
                }
            } else {
                const pid = id();
                state.projects[pid] = { name: 'Inbox', tasks: [] };
                state.currentProject = pid;
                state.history = [];
                state.historyIndex = -1;
                save();
            }
        }

        function getProject() {
            return state.projects[state.currentProject];
        }

        function getTasks() {
            const allTasks = getProject()?.tasks || [];
            let filtered = state.showArchived
                ? allTasks
                : allTasks.filter(t => !t.archived);

            // Apply search query
            if (state.searchQuery) {
                const query = state.searchQuery.toLowerCase();
                filtered = filtered.filter(t => {
                    return t.content.toLowerCase().includes(query) ||
                           (t.delegatedTo && t.delegatedTo.toLowerCase().includes(query)) ||
                           (t.waitingOn && t.waitingOn.toLowerCase().includes(query)) ||
                           (t.dueDate && t.dueDate.toLowerCase().includes(query)) ||
                           (t.notes && t.notes.toLowerCase().includes(query));
                });
            }

            // Apply view filter
            if (state.viewFilter !== 'all') {
                if (state.viewFilter === 'overdue') {
                    const now = new Date();
                    filtered = filtered.filter(t => {
                        if (!t.dueDate || t.status === 'done') return false;
                        const due = new Date(t.dueDate);
                        return due < now;
                    });
                } else {
                    filtered = filtered.filter(t => t.status === state.viewFilter);
                }
            }

            // Sort by custom order
            filtered.sort((a, b) => (a.order || 0) - (b.order || 0));

            return filtered;
        }

        function getTaskCounts() {
            const allTasks = getProject()?.tasks || [];
            const activeTasks = allTasks.filter(t => !t.archived);
            const now = new Date();

            return {
                all: activeTasks.length,
                active: activeTasks.filter(t => t.status === 'active').length,
                waiting: activeTasks.filter(t => t.status === 'waiting').length,
                delegated: activeTasks.filter(t => t.status === 'delegated').length,
                reference: activeTasks.filter(t => t.status === 'reference').length,
                done: activeTasks.filter(t => t.status === 'done').length,
                overdue: activeTasks.filter(t => {
                    if (!t.dueDate || t.status === 'done') return false;
                    const due = new Date(t.dueDate);
                    return due < now;
                }).length
            };
        }

        function getArchivedCount() {
            const allTasks = getProject()?.tasks || [];
            return allTasks.filter(t => t.archived).length;
        }

        // Build graph of people and blockers from history
        function getAllDelegates() {
            const delegates = new Set();
            Object.values(state.projects).forEach(project => {
                project.tasks.forEach(task => {
                    if (task.delegatedTo) {
                        delegates.add(task.delegatedTo);
                    }
                });
            });
            return Array.from(delegates).sort();
        }

        function getAllBlockers() {
            const blockers = new Set();
            Object.values(state.projects).forEach(project => {
                project.tasks.forEach(task => {
                    if (task.waitingOn) {
                        blockers.add(task.waitingOn);
                    }
                });
            });
            return Array.from(blockers).sort();
        }

        function getSuggestions(input, type) {
            if (!input) return [];
            const lower = input.toLowerCase();
            const all = type === 'delegatedTo' ? getAllDelegates() : getAllBlockers();
            return all.filter(item => item.toLowerCase().includes(lower)).slice(0, 5);
        }

        function createTask(content = '', dueDate = null, type = 'task') {
            const tasks = getProject().tasks;
            const maxOrder = tasks.length > 0 ? Math.max(...tasks.map(t => t.order || 0)) : 0;

            const task = {
                id: id(),
                readableId: generateReadableId(type),  // Human-readable ID
                content,
                status: 'active',
                dueDate,
                delegatedTo: null,        // Who it's delegated to
                waitingOn: null,          // What/who we're waiting on
                archived: false,          // Archived instead of deleted
                archivedAt: null,
                createdAt: new Date().toISOString(),
                links: [],                // Links to other tasks
                notes: '',                // Extended notes
                priority: 'none',         // Priority: none, low, medium, high
                order: maxOrder + 1,      // Custom order for drag and drop

                // RAID fields
                type: type,               // Type: task, risk, assumption, issue, dependency

                // RAID Relationships
                relationships: [],        // Array of { type: 'converted-from'|'related-to'|'blocks'|'blocked-by', targetId: string, targetReadableId: string }
                convertedFrom: null,      // If this was converted from another item: { type: 'assumption'|'risk', id: string, readableId: string, reason: string }

                // Risk-specific fields
                likelihood: 'medium',     // Likelihood: low, medium, high
                impact: 'medium',         // Impact: low, medium, high
                mitigation: '',           // Mitigation strategy
                riskResponse: 'mitigate', // Response: avoid, transfer, mitigate, accept
                riskOwner: '',           // Who owns this risk

                // Assumption-specific fields
                validationCriteria: '',   // How to validate assumption
                assumptionOwner: '',      // Who owns validating this
                validated: false,         // Whether assumption is validated
                criticality: 'medium',    // Criticality if wrong: low, medium, high
                evidence: '',             // Proof/documentation of validation

                // Issue-specific fields
                severity: 'medium',       // Severity: low, medium, high, critical
                resolutionPlan: '',       // Plan to resolve issue
                rootCause: '',            // Why it happened
                issueStatus: 'open',      // Status: open, in-progress, resolved, closed
                resolvedAt: null,         // When resolved

                // Dependency-specific fields
                dependencyType: 'external',  // Type: internal, external
                blockerStatus: 'at-risk',    // Status: blocking, at-risk, on-track, resolved
                criticalPath: false          // Is it on critical path
            };
            getProject().tasks.push(task);
            save();
            return task;
        }

        function updateTask(taskId, updates) {
            const task = getTasks().find(t => t.id === taskId);
            if (task) {
                Object.assign(task, updates);
                save();
                render();
            }
        }

        function archiveTask(taskId) {
            const task = getProject().tasks.find(t => t.id === taskId);
            if (task) {
                task.archived = true;
                task.archivedAt = new Date().toISOString();
                state.selectedIndex = Math.max(0, Math.min(state.selectedIndex, getTasks().length - 1));
                save();
                render();
            }
        }

        function unarchiveTask(taskId) {
            const task = getProject().tasks.find(t => t.id === taskId);
            if (task) {
                task.archived = false;
                task.archivedAt = null;
                save();
                render();
            }
        }

        // Multi-select Functions
        function toggleTaskSelection(taskId) {
            if (state.selectedTaskIds.has(taskId)) {
                state.selectedTaskIds.delete(taskId);
            } else {
                state.selectedTaskIds.add(taskId);
            }
            updateBulkActionsToolbar();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const tasks = getTasks();
            if (state.selectedTaskIds.size === tasks.length) {
                // Deselect all
                state.selectedTaskIds.clear();
            } else {
                // Select all
                state.selectedTaskIds = new Set(tasks.map(t => t.id));
            }
            updateBulkActionsToolbar();
            render();
        }

        function clearSelection() {
            state.selectedTaskIds.clear();
            updateBulkActionsToolbar();
            render();
        }

        function updateBulkActionsToolbar() {
            const toolbar = document.getElementById('bulkActionsToolbar');
            const selectedCount = document.getElementById('selectedCount');

            if (state.selectedTaskIds.size > 0) {
                toolbar?.classList.remove('hidden');
                if (selectedCount) {
                    selectedCount.textContent = `${state.selectedTaskIds.size} selected`;
                }
            } else {
                toolbar?.classList.add('hidden');
            }

            // Update checkboxes
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                const taskId = checkbox.dataset.taskId;
                checkbox.checked = state.selectedTaskIds.has(taskId);
            });
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                const tasks = getTasks();
                selectAllCheckbox.checked = tasks.length > 0 && state.selectedTaskIds.size === tasks.length;
                selectAllCheckbox.indeterminate = state.selectedTaskIds.size > 0 && state.selectedTaskIds.size < tasks.length;
            }
        }

        function bulkMarkDone() {
            if (state.selectedTaskIds.size === 0) return;

            state.selectedTaskIds.forEach(taskId => {
                const task = getProject().tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = task.status === 'done' ? 'active' : 'done';
                    if (task.status === 'done') {
                        task.completedAt = new Date().toISOString();
                    }
                }
            });

            clearSelection();
            save();
            render();
        }

        function bulkArchive() {
            if (state.selectedTaskIds.size === 0) return;

            if (!confirm(`Archive ${state.selectedTaskIds.size} task(s)?`)) return;

            state.selectedTaskIds.forEach(taskId => {
                archiveTask(taskId);
            });

            clearSelection();
        }

        // RAID Conversion Functions
        function convertToRisk(taskId, reason = '') {
            const sourceTask = getTasks().find(t => t.id === taskId);
            if (!sourceTask) return;

            const reasonText = reason || prompt(`Why convert ${sourceTask.readableId} to a Risk?`, 'Assumption challenged or uncertainty identified');
            if (!reasonText) return;

            // Create new risk
            const newRisk = createTask(sourceTask.content, sourceTask.dueDate, 'risk');

            // Copy relevant data and set conversion tracking
            newRisk.notes = sourceTask.notes;
            newRisk.convertedFrom = {
                type: sourceTask.type,
                id: sourceTask.id,
                readableId: sourceTask.readableId,
                reason: reasonText,
                convertedAt: new Date().toISOString()
            };

            // If converting from assumption, inherit criticality as likelihood
            if (sourceTask.type === 'assumption') {
                newRisk.likelihood = sourceTask.criticality;
            }

            // Archive the source
            archiveTask(taskId);

            save();
            render();

            // Select the new risk
            const tasks = getTasks();
            const newIndex = tasks.findIndex(t => t.id === newRisk.id);
            if (newIndex >= 0) {
                state.selectedIndex = newIndex;
            }
        }

        function convertToIssue(taskId, reason = '') {
            const sourceTask = getTasks().find(t => t.id === taskId);
            if (!sourceTask) return;

            const reasonText = reason || prompt(`Why convert ${sourceTask.readableId} to an Issue?`, 'Risk has materialized');
            if (!reasonText) return;

            // Create new issue
            const newIssue = createTask(sourceTask.content, sourceTask.dueDate, 'issue');

            // Copy relevant data
            newIssue.notes = sourceTask.notes;
            newIssue.convertedFrom = {
                type: sourceTask.type,
                id: sourceTask.id,
                readableId: sourceTask.readableId,
                reason: reasonText,
                convertedAt: new Date().toISOString()
            };

            // If converting from risk, inherit impact as severity
            if (sourceTask.type === 'risk') {
                const severityMap = { low: 'low', medium: 'medium', high: 'high' };
                newIssue.severity = severityMap[sourceTask.impact] || 'medium';
                newIssue.rootCause = `Risk materialized: ${sourceTask.mitigation || 'No mitigation was in place'}`;
            }

            // Archive the source
            archiveTask(taskId);

            save();
            render();

            // Select the new issue
            const tasks = getTasks();
            const newIndex = tasks.findIndex(t => t.id === newIssue.id);
            if (newIndex >= 0) {
                state.selectedIndex = newIndex;
            }
        }

        function convertToDependency(taskId, reason = '') {
            const sourceTask = getTasks().find(t => t.id === taskId);
            if (!sourceTask) return;

            const reasonText = reason || prompt(`Why convert ${sourceTask.readableId} to a Dependency?`, 'Waiting on external party or deliverable');
            if (!reasonText) return;

            // Create new dependency
            const newDep = createTask(sourceTask.content, sourceTask.dueDate, 'dependency');

            // Copy relevant data
            newDep.notes = sourceTask.notes;
            newDep.convertedFrom = {
                type: sourceTask.type,
                id: sourceTask.id,
                readableId: sourceTask.readableId,
                reason: reasonText,
                convertedAt: new Date().toISOString()
            };

            // If converting from issue, mark as blocking
            if (sourceTask.type === 'issue') {
                newDep.blockerStatus = 'blocking';
            }

            // Archive the source
            archiveTask(taskId);

            save();
            render();

            // Select the new dependency
            const tasks = getTasks();
            const newIndex = tasks.findIndex(t => t.id === newDep.id);
            if (newIndex >= 0) {
                state.selectedIndex = newIndex;
            }
        }

        function addRelationship(sourceId, targetId, relationshipType) {
            const sourceTask = getTasks().find(t => t.id === sourceId);
            const targetTask = getTasks().find(t => t.id === targetId);

            if (!sourceTask || !targetTask) return;

            // Add relationship
            if (!sourceTask.relationships) sourceTask.relationships = [];

            const existingRel = sourceTask.relationships.find(r => r.targetId === targetId);
            if (!existingRel) {
                sourceTask.relationships.push({
                    type: relationshipType,
                    targetId: targetTask.id,
                    targetReadableId: targetTask.readableId,
                    createdAt: new Date().toISOString()
                });
            }

            save();
            render();
        }

        function cycleStatus(taskId) {
            const task = getTasks().find(t => t.id === taskId);
            if (!task) return;

            const cycle = ['active', 'waiting', 'delegated', 'reference', 'done'];
            const current = cycle.indexOf(task.status);
            const next = (current + 1) % cycle.length;
            const nextStatus = cycle[next];

            // Just change status - user can edit delegation/waiting fields inline
            if (nextStatus === 'delegated' || nextStatus === 'waiting') {
                updateTask(taskId, { status: nextStatus });
            } else {
                // Clear delegation/waiting info when changing to other statuses
                updateTask(taskId, {
                    status: nextStatus,
                    delegatedTo: null,
                    waitingOn: null
                });
            }
        }

        function cyclePriority(taskId) {
            const task = getTasks().find(t => t.id === taskId);
            if (!task) return;

            const cycle = ['none', 'low', 'medium', 'high'];
            const current = cycle.indexOf(task.priority || 'none');
            const next = (current + 1) % cycle.length;

            updateTask(taskId, { priority: cycle[next] });
        }

        // RAID field management functions
        function cycleRaidField(taskId, field) {
            const task = getTasks().find(t => t.id === taskId);
            if (!task) return;

            let cycle;
            if (field === 'likelihood' || field === 'impact') {
                cycle = ['low', 'medium', 'high'];
            } else if (field === 'severity') {
                cycle = ['low', 'medium', 'high', 'critical'];
            } else {
                return;
            }

            const current = cycle.indexOf(task[field] || 'medium');
            const next = (current + 1) % cycle.length;

            updateTask(taskId, { [field]: cycle[next] });
        }

        function startEditingRaidField(taskId, field) {
            const task = getTasks().find(t => t.id === taskId);
            if (!task) return;

            state.editingTaskId = taskId;
            state.editingField = field;
            render();

            setTimeout(() => {
                const value = task[field] || '';
                const existingDiv = event.target.closest('div[ondblclick]');
                if (!existingDiv) return;

                const input = document.createElement('input');
                input.type = 'text';
                input.value = value;
                input.className = 'w-full px-2 py-1 bg-white dark:bg-gray-900 border border-blue-500 focus:ring-2 focus:ring-blue-500 rounded text-sm';
                input.placeholder = `Enter ${field}...`;

                input.onblur = () => {
                    updateTask(taskId, { [field]: input.value });
                    state.editingTaskId = null;
                    state.editingField = null;
                    render();
                };

                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    } else if (e.key === 'Escape') {
                        state.editingTaskId = null;
                        state.editingField = null;
                        render();
                    }
                };

                existingDiv.innerHTML = '';
                existingDiv.appendChild(input);
                input.focus();
            }, 10);
        }

        function toggleValidation(taskId) {
            const task = getTasks().find(t => t.id === taskId);
            if (!task) return;

            updateTask(taskId, { validated: !task.validated });
        }

        function reorderTask(draggedTaskId, targetTaskId) {
            const tasks = getProject().tasks;
            const draggedTask = tasks.find(t => t.id === draggedTaskId);
            const targetTask = tasks.find(t => t.id === targetTaskId);

            if (!draggedTask || !targetTask) return;

            // Get the target order and reorder all tasks
            const targetOrder = targetTask.order || 0;
            const draggedOrder = draggedTask.order || 0;

            if (draggedOrder < targetOrder) {
                // Moving down: decrement orders between dragged and target
                tasks.forEach(t => {
                    if (t.order > draggedOrder && t.order <= targetOrder) {
                        t.order--;
                    }
                });
                draggedTask.order = targetOrder;
            } else {
                // Moving up: increment orders between target and dragged
                tasks.forEach(t => {
                    if (t.order >= targetOrder && t.order < draggedOrder) {
                        t.order++;
                    }
                });
                draggedTask.order = targetOrder;
            }

            save();
            render();
        }

        function getPriorityDisplay(priority) {
            const displays = {
                high: { icon: 'üî¥', label: 'High', color: 'text-red-600 dark:text-red-400', bg: 'bg-red-50 dark:bg-red-900/20' },
                medium: { icon: 'üü°', label: 'Medium', color: 'text-yellow-600 dark:text-yellow-400', bg: 'bg-yellow-50 dark:bg-yellow-900/20' },
                low: { icon: 'üü¢', label: 'Low', color: 'text-green-600 dark:text-green-400', bg: 'bg-green-50 dark:bg-green-900/20' },
                none: { icon: '‚ö™', label: 'None', color: 'text-gray-400', bg: 'bg-gray-50 dark:bg-gray-800' }
            };
            return displays[priority || 'none'];
        }

        // Task linking functions
        function addLink(sourceTaskId, targetTaskId, linkType = 'relates-to') {
            const allTasks = getProject().tasks;
            const sourceTask = allTasks.find(t => t.id === sourceTaskId);
            if (!sourceTask) return false;

            // Ensure links array exists
            if (!sourceTask.links) sourceTask.links = [];

            // Check if link already exists
            const existingLink = sourceTask.links.find(l => l.taskId === targetTaskId);
            if (existingLink) {
                existingLink.type = linkType; // Update type if it exists
            } else {
                sourceTask.links.push({ taskId: targetTaskId, type: linkType });
            }
            save();
            return true;
        }

        function removeLink(sourceTaskId, targetTaskId) {
            const allTasks = getProject().tasks;
            const sourceTask = allTasks.find(t => t.id === sourceTaskId);
            if (!sourceTask || !sourceTask.links) return false;

            sourceTask.links = sourceTask.links.filter(l => l.taskId !== targetTaskId);
            save();
            return true;
        }

        function getLinkedTasks(taskId) {
            const allTasks = getProject().tasks;
            const task = allTasks.find(t => t.id === taskId);
            if (!task || !task.links) return [];

            return task.links.map(link => {
                const linkedTask = allTasks.find(t => t.id === link.taskId);
                return linkedTask ? { ...link, task: linkedTask } : null;
            }).filter(Boolean);
        }

        function getBacklinks(taskId) {
            const allTasks = getProject().tasks;
            return allTasks.filter(t =>
                t.links && t.links.some(l => l.taskId === taskId)
            ).map(t => ({ task: t, type: t.links.find(l => l.taskId === taskId).type }));
        }

        // Autocomplete functions
        function updateSuggestions(value, type) {
            state.suggestions = getSuggestions(value, type);
            state.suggestionIndex = -1;
            renderSuggestions();
        }

        function renderSuggestions() {
            const container = document.getElementById('suggestions');
            if (!container) return;

            if (state.suggestions.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.innerHTML = state.suggestions.map((suggestion, index) => {
                const isSelected = index === state.suggestionIndex;
                return `
                    <div
                        class="px-3 py-2 text-sm cursor-pointer ${isSelected ? 'bg-primary-100 dark:bg-primary-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}"
                        onmousedown="selectSuggestion('${esc(suggestion)}')"
                    >
                        ${esc(suggestion)}
                    </div>
                `;
            }).join('');
        }

        function handleAutocompleteKey(event, taskId, field) {
            const input = event.target;

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                state.suggestionIndex = Math.min(state.suggestionIndex + 1, state.suggestions.length - 1);
                renderSuggestions();
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                state.suggestionIndex = Math.max(state.suggestionIndex - 1, -1);
                renderSuggestions();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (state.suggestionIndex >= 0 && state.suggestionIndex < state.suggestions.length) {
                    input.value = state.suggestions[state.suggestionIndex];
                }
                finishEditing(taskId, field, input.value);
                state.suggestions = [];
            } else if (event.key === 'Escape') {
                event.preventDefault();
                if (state.suggestions.length > 0) {
                    state.suggestions = [];
                    renderSuggestions();
                } else {
                    cancelEditing();
                }
            }
        }

        function selectSuggestion(value) {
            const input = document.getElementById('editInput');
            if (input) {
                input.value = value;
                state.suggestions = [];
                input.focus();
            }
        }

        // Rendering
        function renderSidebar() {
            // Render sidebar project list
            const sidebarProjectList = document.getElementById('sidebarProjectList');
            if (sidebarProjectList) {
                const projects = Object.keys(state.projects).map(id => ({
                    id,
                    name: state.projects[id].name,
                    taskCount: Object.values(state.projects[id].tasks || {}).filter(t => !t.archived && t.status !== 'done').length
                }));

                sidebarProjectList.innerHTML = projects.map(proj => {
                    const isActive = proj.id === state.currentProject;
                    return `
                        <button onclick="switchProject('${proj.id}')" class="w-full text-left px-3 py-2 text-sm rounded ${isActive ? 'bg-blue-100 dark:bg-blue-900 text-blue-900 dark:text-blue-100 font-medium' : 'hover:bg-gray-200 dark:hover:bg-gray-800'} flex items-center justify-between">
                            <span>${esc(proj.name)}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${proj.taskCount}</span>
                        </button>
                    `;
                }).join('');
            }

            // Update view buttons active state
            const sidebarViewTasks = document.getElementById('sidebarViewTasks');
            const sidebarViewMatrix = document.getElementById('sidebarViewMatrix');
            const sidebarViewRaid = document.getElementById('sidebarViewRaid');
            const sidebarViewArchived = document.getElementById('sidebarViewArchived');

            const activeClass = 'bg-gray-300 dark:bg-gray-700 font-medium';
            const inactiveClass = 'bg-transparent';

            sidebarViewTasks?.classList.toggle(activeClass, !state.showMatrixView && !state.showRaidView && !state.showArchived);
            sidebarViewMatrix?.classList.toggle(activeClass, state.showMatrixView);
            sidebarViewRaid?.classList.toggle(activeClass, state.showRaidView);
            sidebarViewArchived?.classList.toggle(activeClass, state.showArchived);

            // Sync terminology toggle
            const sidebarTermLabel = document.getElementById('sidebarTermLabel');
            const headerTermLabel = document.getElementById('termLabel');
            if (sidebarTermLabel && headerTermLabel) {
                sidebarTermLabel.textContent = headerTermLabel.textContent;
            }
        }

        function switchToListView() {
            state.showMatrixView = false;
            state.showRaidView = false;
            state.showArchived = false;
            render();
        }

        function switchToMatrixView() {
            state.showMatrixView = true;
            state.showRaidView = false;
            state.showArchived = false;
            render();
        }

        function switchToRaidView() {
            state.showMatrixView = false;
            state.showRaidView = true;
            state.showArchived = false;
            render();
        }

        function render() {
            renderProjects();
            renderViewFilter();
            renderSidebar();

            // Toggle between list, matrix, and RAID views
            const taskTable = document.getElementById('taskTable');
            const matrixView = document.getElementById('matrixView');
            const raidView = document.getElementById('raidView');

            if (state.showRaidView) {
                taskTable.classList.add('hidden');
                matrixView.classList.add('hidden');
                raidView.classList.remove('hidden');
                renderRaidView();
            } else if (state.showMatrixView) {
                taskTable.classList.add('hidden');
                matrixView.classList.remove('hidden');
                raidView.classList.add('hidden');
                renderMatrix();
            } else {
                taskTable.classList.remove('hidden');
                matrixView.classList.add('hidden');
                raidView.classList.add('hidden');
                renderTasks();
            }

            renderDetails();
            updateActionBar();
            updateArchivedCount();
            updateBulkActionsToolbar();
            updateSelectAllCheckbox();
        }

        function renderViewFilter() {
            const container = document.getElementById('viewFilter');
            const counts = getTaskCounts();

            const filters = [
                { id: 'all', label: 'All', count: counts.all, color: 'gray' },
                { id: 'active', label: getTerm('active'), count: counts.active, color: 'blue' },
                { id: 'waiting', label: getTerm('waiting'), count: counts.waiting, color: 'yellow' },
                { id: 'delegated', label: getTerm('delegated'), count: counts.delegated, color: 'purple' },
                { id: 'reference', label: getTerm('reference'), count: counts.reference, color: 'sky' },
                { id: 'done', label: getTerm('done'), count: counts.done, color: 'green' },
                { id: 'overdue', label: 'Overdue', count: counts.overdue, color: 'red' }
            ];

            container.innerHTML = `
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mr-2">View:</span>
                    ${filters.map(f => {
                        const isActive = state.viewFilter === f.id;
                        const colorClass = {
                            gray: isActive ? 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100' : 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-150 dark:hover:bg-gray-750',
                            blue: isActive ? 'bg-blue-100 dark:bg-blue-950 text-blue-900 dark:text-blue-100' : 'bg-blue-50 dark:bg-blue-950/50 text-blue-700 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-950',
                            yellow: isActive ? 'bg-yellow-100 dark:bg-yellow-950 text-yellow-900 dark:text-yellow-100' : 'bg-yellow-50 dark:bg-yellow-950/50 text-yellow-700 dark:text-yellow-300 hover:bg-yellow-100 dark:hover:bg-yellow-950',
                            purple: isActive ? 'bg-purple-100 dark:bg-purple-950 text-purple-900 dark:text-purple-100' : 'bg-purple-50 dark:bg-purple-950/50 text-purple-700 dark:text-purple-300 hover:bg-purple-100 dark:hover:bg-purple-950',
                            sky: isActive ? 'bg-sky-100 dark:bg-sky-950 text-sky-900 dark:text-sky-100' : 'bg-sky-50 dark:bg-sky-950/50 text-sky-700 dark:text-sky-300 hover:bg-sky-100 dark:hover:bg-sky-950',
                            green: isActive ? 'bg-green-100 dark:bg-green-950 text-green-900 dark:text-green-100' : 'bg-green-50 dark:bg-green-950/50 text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-950',
                            red: isActive ? 'bg-red-100 dark:bg-red-950 text-red-900 dark:text-red-100' : 'bg-red-50 dark:bg-red-950/50 text-red-700 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-950'
                        }[f.color];

                        return `
                            <button
                                onclick="setViewFilter('${f.id}')"
                                class="px-3 py-1.5 text-xs rounded-lg ${colorClass} ${isActive ? 'font-semibold' : ''}"
                                title="Show ${f.label.toLowerCase()} tasks"
                            >
                                ${f.label} <span class="font-mono">${f.count}</span>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function setViewFilter(filter) {
            state.viewFilter = filter;
            state.selectedIndex = 0;
            render();
        }

        function handleSearch(query) {
            state.searchQuery = query.toLowerCase();
            state.selectedIndex = 0;
            render();
        }

        function clearSearch() {
            state.searchQuery = '';
            document.getElementById('searchInput').value = '';
            render();
        }

        // Export functions
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('exportMenu');
            const btn = document.getElementById('exportMenuBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }

            // Close type selector when clicking outside
            const typePanel = document.getElementById('typeSelectorPanel');
            const typeTrigger = document.getElementById('typeSelectorTrigger');
            if (typePanel && typeTrigger && !typePanel.contains(e.target) && !typeTrigger.contains(e.target)) {
                if (state.showTypeSelector) {
                    state.showTypeSelector = false;
                    typePanel.classList.add('hidden');
                }
            }
        });

        function exportMarkdown() {
            let markdown = '# Dash-Plus Export\n\n';
            markdown += `Exported: ${new Date().toLocaleString()}\n\n`;

            Object.entries(state.projects).forEach(([pid, project]) => {
                markdown += `## ${project.name}\n\n`;

                const tasks = project.tasks.filter(t => !t.archived);
                if (tasks.length === 0) {
                    markdown += '*No active tasks*\n\n';
                    return;
                }

                // Separate regular tasks and RAID items
                const regularTasks = tasks.filter(t => !t.type || t.type === 'task');
                const raidItems = tasks.filter(t => t.type && t.type !== 'task');

                // Export regular tasks by status
                if (regularTasks.length > 0) {
                    markdown += `### Tasks\n\n`;
                    const byStatus = {
                        active: regularTasks.filter(t => t.status === 'active'),
                        waiting: regularTasks.filter(t => t.status === 'waiting'),
                        delegated: regularTasks.filter(t => t.status === 'delegated'),
                        reference: regularTasks.filter(t => t.status === 'reference'),
                        done: regularTasks.filter(t => t.status === 'done')
                    };

                    Object.entries(byStatus).forEach(([status, statusTasks]) => {
                        if (statusTasks.length === 0) return;

                        markdown += `#### ${getTerm(status)}\n\n`;
                        statusTasks.forEach(task => {
                            const symbol = SYMBOLS[task.status] || '-';
                            markdown += `${symbol} **${task.content}**\n`;

                            if (task.dueDate) markdown += `  - üìÖ Due: ${task.dueDate}\n`;
                            if (task.delegatedTo) markdown += `  - üë§ Delegated to: @${task.delegatedTo}\n`;
                            if (task.waitingOn) markdown += `  - ‚è∏ Waiting on: ${task.waitingOn}\n`;
                            if (task.links && task.links.length > 0) {
                                markdown += `  - üîó Links:\n`;
                                task.links.forEach(link => {
                                    const linkedTask = project.tasks.find(t => t.id === link.taskId);
                                    if (linkedTask) {
                                        const linkInfo = LINK_TYPES[link.type];
                                        markdown += `    - ${linkInfo.icon} ${linkInfo.label}: ${linkedTask.content}\n`;
                                    }
                                });
                            }
                            if (task.notes) markdown += `\n  > ${task.notes}\n`;
                            markdown += '\n';
                        });
                        markdown += '\n';
                    });
                }

                // Export RAID items by type
                if (raidItems.length > 0) {
                    markdown += `### RAID Log\n\n`;

                    const risks = raidItems.filter(t => t.type === 'risk');
                    const assumptions = raidItems.filter(t => t.type === 'assumption');
                    const issues = raidItems.filter(t => t.type === 'issue');
                    const dependencies = raidItems.filter(t => t.type === 'dependency');

                    if (risks.length > 0) {
                        markdown += `#### ‚ö†Ô∏è Risks\n\n`;
                        risks.forEach(risk => {
                            markdown += `- **${risk.content}**\n`;
                            markdown += `  - Likelihood: ${risk.likelihood || 'medium'} | Impact: ${risk.impact || 'medium'}\n`;
                            if (risk.mitigation) markdown += `  - Mitigation: ${risk.mitigation}\n`;
                            if (risk.notes) markdown += `  - Notes: ${risk.notes}\n`;
                            markdown += '\n';
                        });
                        markdown += '\n';
                    }

                    if (assumptions.length > 0) {
                        markdown += `#### üí≠ Assumptions\n\n`;
                        assumptions.forEach(assumption => {
                            markdown += `- **${assumption.content}**\n`;
                            markdown += `  - Status: ${assumption.validated ? '‚úì Validated' : 'Pending Validation'}\n`;
                            if (assumption.assumptionOwner) markdown += `  - Owner: @${assumption.assumptionOwner}\n`;
                            if (assumption.validationCriteria) markdown += `  - Validation Criteria: ${assumption.validationCriteria}\n`;
                            if (assumption.notes) markdown += `  - Notes: ${assumption.notes}\n`;
                            markdown += '\n';
                        });
                        markdown += '\n';
                    }

                    if (issues.length > 0) {
                        markdown += `#### üö® Issues\n\n`;
                        issues.forEach(issue => {
                            markdown += `- **${issue.content}**\n`;
                            markdown += `  - Severity: ${issue.severity || 'medium'}\n`;
                            if (issue.resolutionPlan) markdown += `  - Resolution Plan: ${issue.resolutionPlan}\n`;
                            if (issue.notes) markdown += `  - Notes: ${issue.notes}\n`;
                            markdown += '\n';
                        });
                        markdown += '\n';
                    }

                    if (dependencies.length > 0) {
                        markdown += `#### üîó Dependencies\n\n`;
                        dependencies.forEach(dep => {
                            markdown += `- **${dep.content}**\n`;
                            if (dep.notes) markdown += `  - Notes: ${dep.notes}\n`;
                            markdown += '\n';
                        });
                        markdown += '\n';
                    }
                }
            });

            const dataBlob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dash-plus-${new Date().toISOString().split('T')[0]}.md`;
            link.click();
            URL.revokeObjectURL(url);
            toggleExportMenu();
        }

        function exportPDF() {
            toggleExportMenu();

            // Create print-friendly HTML
            const printWindow = window.open('', '_blank');
            const doc = printWindow.document;

            doc.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dash-Plus Export</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
        h1 { border-bottom: 3px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #3b82f6; margin-top: 30px; }
        h3 { color: #6b7280; margin-top: 20px; font-size: 1.1em; }
        .task { margin: 15px 0; padding: 10px; border-left: 3px solid #e5e7eb; }
        .task-content { font-weight: 600; margin-bottom: 5px; }
        .task-meta { font-size: 0.9em; color: #6b7280; margin-left: 20px; }
        .task-meta div { margin: 3px 0; }
        .symbol { color: #3b82f6; margin-right: 8px; font-family: monospace; font-size: 1.2em; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 0.9em; }
        @media print {
            body { padding: 20px; }
            .task { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <h1>Dash-Plus Export</h1>
    <p><strong>Exported:</strong> ${new Date().toLocaleString()}</p>
`);

            Object.entries(state.projects).forEach(([pid, project]) => {
                doc.write(`<h2>${esc(project.name)}</h2>`);

                const tasks = project.tasks.filter(t => !t.archived);
                if (tasks.length === 0) {
                    doc.write('<p><em>No active tasks</em></p>');
                    return;
                }

                // Separate regular tasks and RAID items
                const regularTasks = tasks.filter(t => !t.type || t.type === 'task');
                const raidItems = tasks.filter(t => t.type && t.type !== 'task');

                // Export regular tasks by status
                if (regularTasks.length > 0) {
                    doc.write('<h3>Tasks</h3>');
                    const byStatus = {
                        active: regularTasks.filter(t => t.status === 'active'),
                        waiting: regularTasks.filter(t => t.status === 'waiting'),
                        delegated: regularTasks.filter(t => t.status === 'delegated'),
                        reference: regularTasks.filter(t => t.status === 'reference'),
                        done: regularTasks.filter(t => t.status === 'done')
                    };

                    Object.entries(byStatus).forEach(([status, statusTasks]) => {
                        if (statusTasks.length === 0) return;

                        doc.write(`<h4 style="font-size: 1em; color: #6b7280; margin-top: 15px;">${getTerm(status)}</h4>`);
                        statusTasks.forEach(task => {
                            const symbol = SYMBOLS[task.status] || '-';
                            doc.write('<div class="task">');
                            doc.write(`<div class="task-content"><span class="symbol">${symbol}</span>${esc(task.content)}</div>`);

                            if (task.dueDate || task.delegatedTo || task.waitingOn || (task.links && task.links.length > 0)) {
                                doc.write('<div class="task-meta">');
                                if (task.dueDate) doc.write(`<div>üìÖ Due: ${esc(task.dueDate)}</div>`);
                                if (task.delegatedTo) doc.write(`<div>üë§ Delegated to: @${esc(task.delegatedTo)}</div>`);
                                if (task.waitingOn) doc.write(`<div>‚è∏ Waiting on: ${esc(task.waitingOn)}</div>`);
                                if (task.links && task.links.length > 0) {
                                    doc.write('<div>üîó Links:<ul style="margin: 5px 0;">');
                                    task.links.forEach(link => {
                                        const linkedTask = project.tasks.find(t => t.id === link.taskId);
                                        if (linkedTask) {
                                            const linkInfo = LINK_TYPES[link.type];
                                            doc.write(`<li>${linkInfo.icon} ${linkInfo.label}: ${esc(linkedTask.content)}</li>`);
                                        }
                                    });
                                    doc.write('</ul></div>');
                                }
                                doc.write('</div>');
                            }
                            doc.write('</div>');
                        });
                    });
                }

                // Export RAID items by type
                if (raidItems.length > 0) {
                    doc.write('<h3 style="margin-top: 30px;">RAID Log</h3>');

                    const risks = raidItems.filter(t => t.type === 'risk');
                    const assumptions = raidItems.filter(t => t.type === 'assumption');
                    const issues = raidItems.filter(t => t.type === 'issue');
                    const dependencies = raidItems.filter(t => t.type === 'dependency');

                    if (risks.length > 0) {
                        doc.write('<h4 style="font-size: 1em; color: #dc2626; margin-top: 20px;">‚ö†Ô∏è Risks</h4>');
                        risks.forEach(risk => {
                            doc.write('<div class="task" style="border-left-color: #fca5a5;">');
                            doc.write(`<div class="task-content">${esc(risk.content)}</div>`);
                            doc.write('<div class="task-meta">');
                            doc.write(`<div>Likelihood: ${risk.likelihood || 'medium'} | Impact: ${risk.impact || 'medium'}</div>`);
                            if (risk.mitigation) doc.write(`<div>Mitigation: ${esc(risk.mitigation)}</div>`);
                            if (risk.notes) doc.write(`<div>Notes: ${esc(risk.notes)}</div>`);
                            doc.write('</div></div>');
                        });
                    }

                    if (assumptions.length > 0) {
                        doc.write('<h4 style="font-size: 1em; color: #2563eb; margin-top: 20px;">üí≠ Assumptions</h4>');
                        assumptions.forEach(assumption => {
                            doc.write('<div class="task" style="border-left-color: #93c5fd;">');
                            doc.write(`<div class="task-content">${esc(assumption.content)}</div>`);
                            doc.write('<div class="task-meta">');
                            doc.write(`<div>Status: ${assumption.validated ? '‚úì Validated' : 'Pending Validation'}</div>`);
                            if (assumption.assumptionOwner) doc.write(`<div>Owner: @${esc(assumption.assumptionOwner)}</div>`);
                            if (assumption.validationCriteria) doc.write(`<div>Validation Criteria: ${esc(assumption.validationCriteria)}</div>`);
                            if (assumption.notes) doc.write(`<div>Notes: ${esc(assumption.notes)}</div>`);
                            doc.write('</div></div>');
                        });
                    }

                    if (issues.length > 0) {
                        doc.write('<h4 style="font-size: 1em; color: #ea580c; margin-top: 20px;">üö® Issues</h4>');
                        issues.forEach(issue => {
                            doc.write('<div class="task" style="border-left-color: #fdba74;">');
                            doc.write(`<div class="task-content">${esc(issue.content)}</div>`);
                            doc.write('<div class="task-meta">');
                            doc.write(`<div>Severity: ${issue.severity || 'medium'}</div>`);
                            if (issue.resolutionPlan) doc.write(`<div>Resolution Plan: ${esc(issue.resolutionPlan)}</div>`);
                            if (issue.notes) doc.write(`<div>Notes: ${esc(issue.notes)}</div>`);
                            doc.write('</div></div>');
                        });
                    }

                    if (dependencies.length > 0) {
                        doc.write('<h4 style="font-size: 1em; color: #7c3aed; margin-top: 20px;">üîó Dependencies</h4>');
                        dependencies.forEach(dep => {
                            doc.write('<div class="task" style="border-left-color: #c4b5fd;">');
                            doc.write(`<div class="task-content">${esc(dep.content)}</div>`);
                            if (dep.notes) {
                                doc.write('<div class="task-meta">');
                                doc.write(`<div>Notes: ${esc(dep.notes)}</div>`);
                                doc.write('</div>');
                            }
                            doc.write('</div>');
                        });
                    }
                }
            });

            doc.write(`
    <div class="footer">
        <p>Generated by Dash-Plus ‚Ä¢ ${new Date().toLocaleDateString()}</p>
    </div>
</body>
</html>
`);

            doc.close();

            // Trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function updateArchivedCount() {
            const count = getArchivedCount();
            document.getElementById('archivedCount').textContent = count;
            const label = TERMINOLOGY[state.terminology].archived;
            document.getElementById('archivedToggle').title = state.showArchived
                ? 'Hide ' + label.toLowerCase()
                : 'Show ' + label.toLowerCase() + ` (${count})`;
        }

        function updateActionBar() {
            const actionBar = document.getElementById('actionBar');
            const tasks = getTasks();
            // Show action bar when a task is selected (in any view mode) and not editing
            if (state.selectedIndex >= 0 && state.selectedIndex < tasks.length && !state.editingTaskId && !state.linkingMode) {
                actionBar.classList.remove('hidden');
            } else {
                actionBar.classList.add('hidden');
            }
        }

        function startEditing(taskId, field, index) {
            state.editingTaskId = taskId;
            state.editingField = field;
            state.selectedIndex = index;
            render();
            // Focus after render
            setTimeout(() => {
                const input = document.getElementById('editInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 10);
        }

        function finishEditing(taskId, field, value) {
            if (field === 'content') {
                updateTask(taskId, { content: value });
            } else if (field === 'dueDate') {
                updateTask(taskId, { dueDate: value });
            } else if (field === 'delegatedTo') {
                updateTask(taskId, { delegatedTo: value || null });
            } else if (field === 'waitingOn') {
                updateTask(taskId, { waitingOn: value || null });
            }
            state.editingTaskId = null;
            state.editingField = null;
            render();
        }

        function cancelEditing() {
            state.editingTaskId = null;
            state.editingField = null;
            render();
        }

        function startEditingNotes(taskId) {
            state.editingTaskId = taskId;
            state.editingField = 'notes';
            render();
            // Focus after render
            setTimeout(() => {
                const textarea = document.getElementById('notesTextarea');
                if (textarea) {
                    textarea.focus();
                    // Move cursor to end
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                }
            }, 10);
        }

        function finishEditingNotes(taskId, value) {
            updateTask(taskId, { notes: value || null });
            state.editingTaskId = null;
            state.editingField = null;
            render();
        }

        // Action bar functions
        function editSelectedTask() {
            const tasks = getTasks();
            const task = tasks[state.selectedIndex];
            if (task) {
                startEditing(task.id, 'content', state.selectedIndex);
            }
        }

        function cycleSelectedStatus() {
            const tasks = getTasks();
            const task = tasks[state.selectedIndex];
            if (task) {
                cycleStatus(task.id);
            }
        }

        function toggleSelectedDone() {
            const tasks = getTasks();
            const task = tasks[state.selectedIndex];
            if (task) {
                const newStatus = task.status === 'done' ? 'active' : 'done';
                // Clear delegatedTo and waitingOn when changing status
                updateTask(task.id, {
                    status: newStatus,
                    delegatedTo: null,
                    waitingOn: null
                });
            }
        }

        function deleteSelectedTask() {
            const tasks = getTasks();
            const task = tasks[state.selectedIndex];
            const archiveLabel = TERMINOLOGY[state.terminology].archive;
            if (task && confirm(`${archiveLabel} this task?`)) {
                archiveTask(task.id);
            }
        }

        function renderProjects() {
            const tabs = document.getElementById('projectTabs');
            tabs.innerHTML = '';

            Object.entries(state.projects).forEach(([pid, project]) => {
                if (state.editingProjectId === pid) {
                    // Render as input
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = project.name;
                    input.className = 'px-3 py-1 text-sm rounded-lg bg-white dark:bg-gray-900 border border-primary-500 focus:ring-2 focus:ring-primary-500';
                    input.onblur = () => {
                        if (input.value.trim()) {
                            state.projects[pid].name = input.value.trim();
                            save();
                        }
                        state.editingProjectId = null;
                        render();
                    };
                    input.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            if (input.value.trim()) {
                                state.projects[pid].name = input.value.trim();
                                save();
                            }
                            state.editingProjectId = null;
                            render();
                        } else if (e.key === 'Escape') {
                            state.editingProjectId = null;
                            render();
                        }
                    };
                    tabs.appendChild(input);
                    setTimeout(() => {
                        input.focus();
                        input.select();
                    }, 10);
                } else {
                    // Render as button
                    const tab = document.createElement('button');
                    tab.className = `px-3 py-1 text-sm rounded-lg ${
                        pid === state.currentProject
                            ? 'bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 font-medium'
                            : 'hover:bg-gray-100 dark:hover:bg-gray-700'
                    }`;
                    tab.textContent = project.name;
                    tab.onclick = () => {
                        state.currentProject = pid;
                        state.selectedIndex = 0;
                        render();
                    };
                    tab.oncontextmenu = (e) => {
                        e.preventDefault();
                        state.editingProjectId = pid;
                        render();
                    };
                    tab.title = 'Right-click to rename';
                    tabs.appendChild(tab);
                }
            });
        }

        function renderTasks() {
            const table = document.getElementById('taskTable');
            const tasks = getTasks();

            table.innerHTML = '';

            // Render existing tasks
            tasks.forEach((task, index) => {
                const row = createTaskRow(task, index);
                table.appendChild(row);
            });

            // Add empty row for new task
            const newRow = createNewTaskRow();
            table.appendChild(newRow);
        }

        function renderMatrix() {
            const tasks = getTasks().filter(t => t.status !== 'done' && !t.archived);
            const now = new Date();

            // Categorize tasks into quadrants
            const quadrants = {
                urgentImportant: [],
                noturgentImportant: [],
                urgentNotimportant: [],
                noturgentNotimportant: []
            };

            tasks.forEach(task => {
                // Determine if urgent (has due date within 3 days or overdue)
                let isUrgent = false;
                if (task.dueDate) {
                    const due = new Date(task.dueDate);
                    const daysUntilDue = (due - now) / (1000 * 60 * 60 * 24);
                    isUrgent = daysUntilDue <= 3;
                }

                // Determine if important (high or medium priority)
                const isImportant = task.priority === 'high' || task.priority === 'medium';

                // Place in appropriate quadrant
                if (isUrgent && isImportant) {
                    quadrants.urgentImportant.push(task);
                } else if (!isUrgent && isImportant) {
                    quadrants.noturgentImportant.push(task);
                } else if (isUrgent && !isImportant) {
                    quadrants.urgentNotimportant.push(task);
                } else {
                    quadrants.noturgentNotimportant.push(task);
                }
            });

            // Render each quadrant
            const quadrantConfig = {
                'matrix-urgent-important': { tasks: quadrants.urgentImportant, priority: 'high', dueDate: 'today' },
                'matrix-noturgent-important': { tasks: quadrants.noturgentImportant, priority: 'high', dueDate: null },
                'matrix-urgent-notimportant': { tasks: quadrants.urgentNotimportant, priority: 'low', dueDate: 'today' },
                'matrix-noturgent-notimportant': { tasks: quadrants.noturgentNotimportant, priority: 'none', dueDate: null }
            };

            Object.entries(quadrantConfig).forEach(([id, config]) => {
                const container = document.getElementById(id);
                const taskHtml = config.tasks.map(task => {
                    const priorityInfo = getPriorityDisplay(task.priority);
                    return `
                        <div class="p-2 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 hover:shadow-sm cursor-pointer text-sm" onclick="selectTaskById('${task.id}')">
                            <div class="flex items-start gap-2">
                                ${priorityInfo.icon}
                                <div class="flex-1">
                                    <div class="font-medium">${esc(task.content)}</div>
                                    ${task.dueDate ? `<div class="text-xs text-gray-500 mt-1">üìÖ ${task.dueDate}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                const addButton = `
                    <button onclick="addTaskToQuadrant('${config.priority}', '${config.dueDate}')" class="mt-2 w-full px-3 py-2 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded border border-dashed border-gray-300 dark:border-gray-600">
                        + Add Task
                    </button>
                `;

                container.innerHTML = (config.tasks.length === 0 ? '<p class="text-sm text-gray-400 italic mb-2">No tasks</p>' : taskHtml) + addButton;
            });
        }

        function addTaskToQuadrant(priority, dueDate) {
            const content = prompt('Enter task description:');
            if (content && content.trim()) {
                const task = createTask(content.trim(), dueDate === 'null' ? null : dueDate);
                updateTask(task.id, { priority: priority });
                render();
            }
        }

        function selectTaskById(taskId) {
            const tasks = getTasks();
            const index = tasks.findIndex(t => t.id === taskId);
            if (index !== -1) {
                state.selectedIndex = index;
                render();
                const isMobile = window.innerWidth < 768;
                if (isMobile && state.bottomSheetState === 'collapsed') {
                    openBottomSheetToHalf();
                }
            }
        }

        function createNewRaidItem(type) {
            const content = prompt(`Enter ${type} description:`);
            if (content && content.trim()) {
                createTask(content.trim(), null, type);
                render();
            }
        }

        function renderRiskMatrix(risks) {
            // Initialize all cells
            const cells = [
                'low-low', 'low-medium', 'low-high',
                'medium-low', 'medium-medium', 'medium-high',
                'high-low', 'high-medium', 'high-high'
            ];

            cells.forEach(cell => {
                const element = document.getElementById(`risk-matrix-${cell}`);
                if (element) element.innerHTML = '';
            });

            // Place risks in matrix cells
            risks.forEach(risk => {
                const likelihood = risk.likelihood || 'medium';
                const impact = risk.impact || 'medium';
                const cellId = `risk-matrix-${likelihood}-${impact}`;
                const cell = document.getElementById(cellId);

                if (cell) {
                    const riskItem = document.createElement('div');
                    riskItem.className = 'mb-2 p-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded text-xs cursor-pointer hover:shadow-sm';
                    riskItem.onclick = () => selectTaskById(risk.id);

                    riskItem.innerHTML = `
                        <div class="font-medium text-gray-900 dark:text-gray-100 line-clamp-2">${esc(risk.content)}</div>
                        ${risk.mitigation ? `<div class="mt-1 text-gray-600 dark:text-gray-400 line-clamp-1">Mitigation: ${esc(risk.mitigation)}</div>` : ''}
                    `;

                    cell.appendChild(riskItem);
                }
            });
        }

        function renderRaidView() {
            const allTasks = getProject()?.tasks || [];
            const activeItems = allTasks.filter(t => !t.archived && t.status !== 'done');

            // Categorize by type
            const risks = activeItems.filter(t => t.type === 'risk');
            const assumptions = activeItems.filter(t => t.type === 'assumption');
            const issues = activeItems.filter(t => t.type === 'issue');
            const dependencies = activeItems.filter(t => t.type === 'dependency');

            // Render Risk Matrix
            renderRiskMatrix(risks);

            // Render Risks
            document.getElementById('raid-risks').innerHTML = risks.length === 0
                ? '<p class="text-sm text-gray-400 italic">No active risks</p>'
                : risks.map(task => renderRaidCard(task, 'risk')).join('');

            // Render Assumptions
            document.getElementById('raid-assumptions').innerHTML = assumptions.length === 0
                ? '<p class="text-sm text-gray-400 italic">No assumptions</p>'
                : assumptions.map(task => renderRaidCard(task, 'assumption')).join('');

            // Render Issues
            document.getElementById('raid-issues').innerHTML = issues.length === 0
                ? '<p class="text-sm text-gray-400 italic">No open issues</p>'
                : issues.map(task => renderRaidCard(task, 'issue')).join('');

            // Render Dependencies
            document.getElementById('raid-dependencies').innerHTML = dependencies.length === 0
                ? '<p class="text-sm text-gray-400 italic">No dependencies</p>'
                : dependencies.map(task => renderRaidCard(task, 'dependency')).join('');
        }

        function renderRaidCard(task, type) {
            const getSeverityBadge = (level) => {
                const badges = {
                    low: '<span class="px-2 py-0.5 text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">Low</span>',
                    medium: '<span class="px-2 py-0.5 text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded">Medium</span>',
                    high: '<span class="px-2 py-0.5 text-xs bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded">High</span>',
                    critical: '<span class="px-2 py-0.5 text-xs bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded">Critical</span>'
                };
                return badges[level] || badges.medium;
            };

            let badge = '';
            if (type === 'risk') {
                badge = `<div class="flex gap-1">${getSeverityBadge(task.likelihood)} √ó ${getSeverityBadge(task.impact)}</div>`;
            } else if (type === 'issue') {
                badge = getSeverityBadge(task.severity);
            } else if (type === 'assumption') {
                badge = task.validated
                    ? '<span class="px-2 py-0.5 text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">‚úì Validated</span>'
                    : '<span class="px-2 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">Pending</span>';
            }

            return `
                <div class="p-3 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 hover:shadow-sm cursor-pointer" onclick="selectTaskById('${task.id}')">
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                ${task.readableId ? `<span class="font-mono text-xs text-gray-500 dark:text-gray-400">${task.readableId}</span>` : ''}
                                ${task.convertedFrom ? `<span class="text-xs text-blue-500 dark:text-blue-400" title="Converted from ${task.convertedFrom.type}">üîÑ</span>` : ''}
                            </div>
                            <div class="font-medium text-sm">${esc(task.content)}</div>
                        </div>
                        ${badge}
                    </div>
                    ${task.status === 'waiting' && task.waitingOn ? `<div class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">‚è∏ ${esc(task.waitingOn)}</div>` : ''}
                    ${task.status === 'delegated' && task.delegatedTo ? `<div class="text-xs text-purple-600 dark:text-purple-400 mt-1">‚Üê @${esc(task.delegatedTo)}</div>` : ''}
                    ${task.dueDate ? `<div class="text-xs text-gray-500 mt-1">üìÖ ${task.dueDate}</div>` : ''}
                </div>
            `;
        }

        function createTaskRow(task, index) {
            const row = document.createElement('div');

            // Check age and due date
            const now = new Date();
            const created = new Date(task.createdAt);
            const ageInDays = (now - created) / (1000 * 60 * 60 * 24);
            const isOld = ageInDays >= 1;

            let isDueOrOverdue = false;
            let dueDateClass = '';
            if (task.dueDate) {
                const due = new Date(task.dueDate);
                const daysUntilDue = (due - now) / (1000 * 60 * 60 * 24);
                if (daysUntilDue <= 3) {  // Due in 3 days or overdue
                    isDueOrOverdue = true;
                    dueDateClass = 'text-red-600 dark:text-red-400 font-medium';
                }
            }

            let symbol = SYMBOLS[task.status] || SYMBOLS.active;
            let titleClass = '';
            let textClass = '';

            // Card-based styling with flat design (borders only, NO shadows)
            let cardBorderClass = 'border border-gray-200 dark:border-gray-700';
            let cardBgClass = 'bg-white dark:bg-gray-900';

            // Status-specific colors for symbols (colorful, not monochrome)
            const statusColors = {
                active: 'text-blue-500 dark:text-blue-400',
                done: 'text-green-600 dark:text-green-500',
                waiting: 'text-amber-500 dark:text-amber-400',
                delegated: 'text-purple-500 dark:text-purple-400',
                reference: 'text-gray-400 dark:text-gray-500'
            };
            let statusColorClass = statusColors[task.status] || statusColors.active;

            // Selected state - change border color only (flat design)
            if (index === state.selectedIndex) {
                cardBorderClass = 'border-2 border-blue-500 dark:border-blue-400';
            }

            // Hover state - just border color change
            const hoverClass = 'hover:border-blue-400 dark:hover:border-blue-500';

            // Apply aging logic
            if (isOld && !isDueOrOverdue && task.status !== 'done') {
                textClass = 'text-gray-400 dark:text-gray-500';
            }

            // Override with due date urgency
            if (isDueOrOverdue && task.status !== 'done') {
                cardBorderClass = 'border-2 border-red-400 dark:border-red-500';
                cardBgClass = 'bg-red-50/30 dark:bg-red-950/20';
                textClass = '';  // Override greying
            }

            if (task.status === 'done') {
                titleClass = 'line-through opacity-60';
            }

            // Card styling: rounded corners, padding, spacing
            row.className = `${cardBgClass} ${cardBorderClass} ${hoverClass} rounded-lg px-4 py-3 mb-3 cursor-pointer transition-colors ${textClass}`;
            row.draggable = true;
            row.dataset.taskId = task.id;
            row.dataset.taskIndex = index;

            const isEditing = state.editingTaskId === task.id;

            const priorityInfo = getPriorityDisplay(task.priority);

            // Build metadata chips array
            let metadataChips = [];

            // Due date chip
            if (task.dueDate) {
                const chipBg = isDueOrOverdue ? 'bg-red-100/50 dark:bg-red-900/30' : 'bg-gray-100 dark:bg-gray-800';
                const chipText = isDueOrOverdue ? 'text-red-700 dark:text-red-400' : 'text-gray-600 dark:text-gray-400';
                metadataChips.push(`<span class="inline-flex items-center gap-1 px-2 py-1 text-sm ${chipBg} ${chipText} rounded-md border border-gray-300 dark:border-gray-600 cursor-pointer hover:opacity-80 transition-opacity" ondblclick="event.stopPropagation(); startEditing('${task.id}', 'dueDate', ${index})" title="Double-click to edit due date">üìÖ ${task.dueDate}</span>`);
            }

            // Priority chip
            if (task.priority && task.priority !== 'none') {
                const priorityBg = {
                    high: 'bg-red-100/50 dark:bg-red-900/30 border-red-300 dark:border-red-700 text-red-700 dark:text-red-400',
                    medium: 'bg-amber-100/50 dark:bg-amber-900/30 border-amber-300 dark:border-amber-700 text-amber-700 dark:text-amber-400',
                    low: 'bg-green-100/50 dark:bg-green-900/30 border-green-300 dark:border-green-700 text-green-700 dark:text-green-400'
                };
                metadataChips.push(`<span class="inline-flex items-center gap-1 px-2 py-1 text-sm ${priorityBg[task.priority]} rounded-md border">${priorityInfo.icon} ${priorityInfo.label}</span>`);
            }

            // Delegated chip
            if (task.status === 'delegated' && task.delegatedTo && !isEditing) {
                metadataChips.push(`<span class="inline-flex items-center gap-1 px-2 py-1 text-sm bg-purple-100/50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-md border border-purple-300 dark:border-purple-700 cursor-pointer hover:opacity-80 transition-opacity" ondblclick="event.stopPropagation(); startEditing('${task.id}', 'delegatedTo', ${index})" title="Delegated to: ${esc(task.delegatedTo)}">‚Üê @${esc(task.delegatedTo)}</span>`);
            }

            // Waiting chip
            if (task.status === 'waiting' && task.waitingOn && !isEditing) {
                metadataChips.push(`<span class="inline-flex items-center gap-1 px-2 py-1 text-sm bg-amber-100/50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-md border border-amber-300 dark:border-amber-700 cursor-pointer hover:opacity-80 transition-opacity" ondblclick="event.stopPropagation(); startEditing('${task.id}', 'waitingOn', ${index})" title="Waiting on: ${esc(task.waitingOn)}">‚Üí ${esc(task.waitingOn)}</span>`);
            }

            // Links chip
            if (task.links && task.links.length > 0) {
                metadataChips.push(`<span class="inline-flex items-center gap-1 px-2 py-1 text-sm bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-md border border-gray-300 dark:border-gray-600">üîó ${task.links.length}</span>`);
            }

            // Notes chip
            if (task.notes) {
                metadataChips.push(`<span class="inline-flex items-center gap-1 px-2 py-1 text-sm bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-md border border-gray-300 dark:border-gray-600">üìù Notes</span>`);
            }

            row.innerHTML = `
                <div class="flex flex-col gap-3">
                    <!-- Header: Checkbox + Status icon + Title + Archive -->
                    <div class="flex items-start gap-3">
                        <!-- Checkbox (Desktop only) -->
                        <input type="checkbox" class="task-checkbox hidden lg:block w-5 h-5 mt-0.5 rounded border-gray-300 dark:border-gray-600 flex-shrink-0" data-task-id="${task.id}" onclick="event.stopPropagation(); toggleTaskSelection('${task.id}')" title="Select task">

                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="hidden md:inline text-gray-400 cursor-move" title="Drag to reorder">‚†ø</span>
                            <button onclick="event.stopPropagation(); cycleStatus('${task.id}')" class="text-xl font-mono ${statusColorClass} hover:opacity-80 min-w-[44px] min-h-[44px] flex items-center justify-center rounded-full transition-opacity" title="Click to cycle status">
                                ${symbol}
                            </button>
                        </div>
                        <div class="flex-1 min-w-0">
                            ${isEditing && state.editingField === 'content' ? `
                                <input
                                    type="text"
                                    id="editInput"
                                    value="${esc(task.content)}"
                                    onblur="finishEditing('${task.id}', 'content', this.value)"
                                    onkeydown="if(event.key==='Enter') { finishEditing('${task.id}', 'content', this.value); } if(event.key==='Escape') { cancelEditing(); }"
                                    class="w-full px-3 py-2 text-base bg-white dark:bg-gray-900 border-2 border-blue-500 focus:ring-0 focus:border-blue-600 rounded-md"
                                    placeholder="Task description..."
                                />
                            ` : `
                                <div class="text-base leading-6 font-medium text-gray-900 dark:text-gray-100 cursor-text ${titleClass}" ondblclick="event.stopPropagation(); startEditing('${task.id}', 'content', ${index})" title="Double-click to edit: ${esc(task.content)}">
                                    ${esc(task.content) || '<span class="text-gray-400">Task description...</span>'}
                                </div>
                            `}
                        </div>
                        <button onclick="event.stopPropagation(); if(confirm('${TERMINOLOGY[state.terminology].archive}?')) archiveTask('${task.id}')" class="text-gray-400 hover:text-red-500 min-w-[44px] min-h-[44px] flex items-center justify-center flex-shrink-0 transition-colors" title="${TERMINOLOGY[state.terminology].archive}">
                            üóëÔ∏è
                        </button>
                    </div>

                    <!-- Metadata chips row -->
                    ${metadataChips.length > 0 || isEditing ? `
                        <div class="flex flex-wrap items-center gap-2 pl-14 lg:pl-20">
                            ${metadataChips.join('')}
                            ${!task.dueDate && !isEditing ? `<span class="inline-flex items-center gap-1 px-2 py-1 text-sm bg-gray-50 dark:bg-gray-800 text-gray-400 dark:text-gray-500 rounded-md border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" ondblclick="event.stopPropagation(); startEditing('${task.id}', 'dueDate', ${index})" title="Double-click to set due date">üìÖ Set due date</span>` : ''}
                        </div>
                    ` : ''}

                    <!-- Editing field for delegatedTo/waitingOn/dueDate -->
                    ${isEditing && (state.editingField === 'delegatedTo' || state.editingField === 'waitingOn' || state.editingField === 'dueDate') ? `
                        <div class="pl-14 lg:pl-20 relative">
                            ${state.editingField === 'dueDate' ? `
                                <input
                                    type="text"
                                    id="editInput"
                                    value="${task.dueDate || ''}"
                                    onblur="finishEditing('${task.id}', 'dueDate', this.value)"
                                    onkeydown="if(event.key==='Enter') { finishEditing('${task.id}', 'dueDate', this.value); } if(event.key==='Escape') { cancelEditing(); }"
                                    class="w-full max-w-xs px-3 py-2 text-sm bg-white dark:bg-gray-900 border-2 border-blue-500 focus:ring-0 focus:border-blue-600 rounded-md"
                                    placeholder="tomorrow, next week, Q1..."
                                />
                            ` : `
                                <input
                                    type="text"
                                    id="editInput"
                                    value="${esc(state.editingField === 'delegatedTo' ? (task.delegatedTo || '') : (task.waitingOn || ''))}"
                                    oninput="updateSuggestions(this.value, '${state.editingField}')"
                                    onblur="setTimeout(() => { finishEditing('${task.id}', '${state.editingField}', this.value); }, 150)"
                                    onkeydown="handleAutocompleteKey(event, '${task.id}', '${state.editingField}')"
                                    class="w-full max-w-xs px-3 py-2 text-sm bg-white dark:bg-gray-900 border-2 ${state.editingField === 'delegatedTo' ? 'border-purple-500 focus:border-purple-600' : 'border-amber-500 focus:border-amber-600'} focus:ring-0 rounded-md"
                                    placeholder="${state.editingField === 'delegatedTo' ? 'Delegated to... (type to search)' : 'Waiting on... (type to search)'}"
                                    autocomplete="off"
                                />
                                <div id="suggestions" class="absolute z-10 w-full max-w-xs mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md max-h-32 overflow-y-auto shadow-lg"></div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;

            row.onclick = () => {
                state.selectedIndex = index;
                render();
            };

            // Drag and drop handlers
            row.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', task.id);
                row.classList.add('opacity-50');
            });

            row.addEventListener('dragend', (e) => {
                row.classList.remove('opacity-50');
            });

            row.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                row.classList.add('border-t-4', 'border-blue-500');
            });

            row.addEventListener('dragleave', (e) => {
                row.classList.remove('border-t-4', 'border-blue-500');
            });

            row.addEventListener('drop', (e) => {
                e.preventDefault();
                row.classList.remove('border-t-4', 'border-blue-500');

                const draggedTaskId = e.dataTransfer.getData('text/plain');
                const targetTaskId = task.id;

                if (draggedTaskId !== targetTaskId) {
                    reorderTask(draggedTaskId, targetTaskId);
                }
            });

            return row;
        }

        function setNewTaskType(type) {
            state.newTaskType = type;

            // Update button styles in floating panel
            const types = ['task', 'risk', 'assumption', 'issue', 'dependency'];
            types.forEach(t => {
                const btn = document.getElementById(`typeBtn-${t}`);
                if (btn) {
                    if (t === type) {
                        btn.className = 'w-full px-4 py-3 text-left rounded-lg bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900 transition-colors flex items-center gap-2';
                    } else {
                        btn.className = 'w-full px-4 py-3 text-left rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-2';
                    }
                }
            });

            // Update trigger button icon
            const typeIcons = {
                task: 'üìù',
                risk: '‚ö†Ô∏è',
                assumption: 'üí≠',
                issue: 'üö®',
                dependency: 'üîó'
            };
            const iconElement = document.getElementById('currentTypeIcon');
            if (iconElement) {
                iconElement.textContent = typeIcons[type];
            }

            // Close the floating panel
            state.showTypeSelector = false;
            const panel = document.getElementById('typeSelectorPanel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        function toggleTypeSelector(event) {
            event.stopPropagation();
            state.showTypeSelector = !state.showTypeSelector;
            const panel = document.getElementById('typeSelectorPanel');

            if (!panel) {
                console.error('Type selector panel not found');
                return;
            }

            if (state.showTypeSelector) {
                panel.classList.remove('hidden');

                // Position the panel near the trigger button
                const trigger = document.getElementById('typeSelectorTrigger');
                if (trigger) {
                    const rect = trigger.getBoundingClientRect();
                    const isMobile = window.innerWidth < 768;

                    if (isMobile) {
                        // Mobile: Center the panel horizontally, position below trigger with safe margins
                        panel.style.top = `${Math.min(rect.bottom + 8, window.innerHeight - 400)}px`;
                        panel.style.left = '50%';
                        panel.style.transform = 'translateX(-50%)';
                        panel.style.right = 'auto';
                    } else {
                        // Desktop: Position to the right of trigger
                        panel.style.top = `${rect.bottom + 8}px`;
                        panel.style.right = `${window.innerWidth - rect.right}px`;
                        panel.style.left = 'auto';
                        panel.style.transform = 'none';
                    }
                }
            } else {
                panel.classList.add('hidden');
            }
        }

        function handleNewTaskBlur(input) {
            if (input.value.trim()) {
                createTask(input.value.trim(), null, state.newTaskType);
                input.value = '';
                state.newTaskType = 'task'; // Reset to default
                render();
            } else {
                input.placeholder = "Click to add new task... (or press 'n')";
            }
        }

        function handleNewTaskKeydown(event, input) {
            if (event.key === 'Enter' && input.value.trim()) {
                createTask(input.value.trim(), null, state.newTaskType);
                input.value = '';
                state.newTaskType = 'task'; // Reset to default
                render();
                event.preventDefault();
            }
        }

        function createNewTaskRow() {
            const row = document.createElement('div');
            row.className = 'px-4 py-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50';

            const typeIcons = {
                task: 'üìù',
                risk: '‚ö†Ô∏è',
                assumption: 'üí≠',
                issue: 'üö®',
                dependency: 'üîó'
            };

            row.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg font-mono text-gray-400 w-8 h-8 flex items-center justify-center flex-shrink-0">-</span>
                    <input
                        id="newTaskInput"
                        type="text"
                        placeholder="Click to add new task... (or press 'n')"
                        onfocus="this.placeholder='Type task description...'"
                        onblur="handleNewTaskBlur(this)"
                        onkeydown="handleNewTaskKeydown(event, this)"
                        class="flex-1 px-2 py-1 min-h-[44px] bg-transparent border border-transparent hover:border-gray-300 dark:hover:border-gray-600 focus:border-primary-500 focus:ring-1 focus:ring-primary-500 rounded text-gray-500 focus:text-gray-900 dark:focus:text-gray-100"
                    />
                    <button
                        id="typeSelectorTrigger"
                        onclick="toggleTypeSelector(event)"
                        class="px-3 py-2 text-sm rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center gap-1 flex-shrink-0"
                        title="Select task type"
                    >
                        <span id="currentTypeIcon">${typeIcons[state.newTaskType]}</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
            `;

            return row;
        }

        function getRaidDetailsSection(task) {
            if (!task.type || task.type === 'task') return '';

            const typeLabels = {
                risk: { icon: '‚ö†Ô∏è', label: 'Risk', color: 'text-red-600 dark:text-red-400' },
                assumption: { icon: 'üí≠', label: 'Assumption', color: 'text-blue-600 dark:text-blue-400' },
                issue: { icon: 'üö®', label: 'Issue', color: 'text-orange-600 dark:text-orange-400' },
                dependency: { icon: 'üîó', label: 'Dependency', color: 'text-purple-600 dark:text-purple-400' }
            };
            const typeInfo = typeLabels[task.type];
            if (!typeInfo) return '';

            let fieldsHtml = '';

            if (task.type === 'risk') {
                const getBadge = (level) => {
                    const badges = {
                        low: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
                        medium: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
                        high: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'
                    };
                    return badges[level] || badges.medium;
                };

                fieldsHtml = `
                    <div class="space-y-2 text-sm">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <span class="text-gray-600 dark:text-gray-400">Likelihood:</span>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="px-2 py-1 text-xs ${getBadge(task.likelihood)} rounded">${task.likelihood || 'medium'}</span>
                                    <button onclick="cycleRaidField('${task.id}', 'likelihood')" class="px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">Change</button>
                                </div>
                            </div>
                            <div class="flex-1">
                                <span class="text-gray-600 dark:text-gray-400">Impact:</span>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="px-2 py-1 text-xs ${getBadge(task.impact)} rounded">${task.impact || 'medium'}</span>
                                    <button onclick="cycleRaidField('${task.id}', 'impact')" class="px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">Change</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Mitigation:</span>
                            <div class="mt-1 text-sm text-gray-700 dark:text-gray-300 cursor-text hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded min-h-[40px]" ondblclick="event.stopPropagation(); startEditingRaidField('${task.id}', 'mitigation')" title="Double-click to edit">${task.mitigation ? esc(task.mitigation) : '<span class="italic text-gray-400">No mitigation. Double-click to add...</span>'}</div>
                        </div>
                    </div>
                `;
            } else if (task.type === 'assumption') {
                fieldsHtml = `
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Owner:</span>
                            <div class="mt-1 text-sm text-gray-700 dark:text-gray-300 cursor-text hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded" ondblclick="event.stopPropagation(); startEditingRaidField('${task.id}', 'assumptionOwner')" title="Double-click to edit">${task.assumptionOwner ? '@' + esc(task.assumptionOwner) : '<span class="italic text-gray-400">No owner. Double-click to add...</span>'}</div>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Validation Criteria:</span>
                            <div class="mt-1 text-sm text-gray-700 dark:text-gray-300 cursor-text hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded min-h-[40px]" ondblclick="event.stopPropagation(); startEditingRaidField('${task.id}', 'validationCriteria')" title="Double-click to edit">${task.validationCriteria ? esc(task.validationCriteria) : '<span class="italic text-gray-400">No criteria. Double-click to add...</span>'}</div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Status:</span>
                            <button onclick="toggleValidation('${task.id}')" class="px-3 py-1 text-xs ${task.validated ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'} hover:opacity-80 rounded">${task.validated ? '‚úì Validated' : 'Pending'}</button>
                        </div>
                    </div>
                `;
            } else if (task.type === 'issue') {
                const severityClasses = {
                    low: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
                    medium: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
                    high: 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300',
                    critical: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'
                };
                const sevClass = severityClasses[task.severity] || severityClasses.medium;

                fieldsHtml = `
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Severity:</span>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 text-xs ${sevClass} rounded">${task.severity || 'medium'}</span>
                                <button onclick="cycleRaidField('${task.id}', 'severity')" class="px-2 py-1 text-xs text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded">Change</button>
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600 dark:text-gray-400">Resolution Plan:</span>
                            <div class="mt-1 text-sm text-gray-700 dark:text-gray-300 cursor-text hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded min-h-[40px]" ondblclick="event.stopPropagation(); startEditingRaidField('${task.id}', 'resolutionPlan')" title="Double-click to edit">${task.resolutionPlan ? esc(task.resolutionPlan) : '<span class="italic text-gray-400">No plan. Double-click to add...</span>'}</div>
                        </div>
                    </div>
                `;
            } else if (task.type === 'dependency') {
                fieldsHtml = `
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <p>Dependencies are tracked via task links. Use the "Links" section below.</p>
                    </div>
                `;
            }

            return `
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-2 mb-3 ${typeInfo.color}">
                        <span>${typeInfo.icon}</span>
                        <h3 class="text-sm font-semibold">${typeInfo.label} Details</h3>
                    </div>
                    ${fieldsHtml}
                </div>
            `;
        }

        function renderDetails() {
            const panel = document.getElementById('detailsPanel');
            const tasks = getTasks();
            const task = tasks[state.selectedIndex];

            if (!task) {
                panel.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center text-gray-400">
                        <div>
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-lg">Select a task to view details</p>
                            <p class="mt-2 text-sm">or press <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs font-mono">n</kbd> to create a new one</p>
                        </div>
                    </div>
                `;
                return;
            }

            let statusBadge = '';
            if (task.archived) statusBadge = '<span class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-300 rounded-full text-xs font-medium">' + getTerm('archived').toUpperCase() + '</span>';
            else if (task.status === 'waiting') statusBadge = '<span class="inline-block px-3 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-medium">' + getTerm('waiting') + '</span>';
            else if (task.status === 'delegated') statusBadge = '<span class="inline-block px-3 py-1 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-full text-xs font-medium">' + getTerm('delegated') + '</span>';
            else if (task.status === 'reference') statusBadge = '<span class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full text-xs font-medium">' + getTerm('reference') + '</span>';
            else if (task.status === 'done') statusBadge = '<span class="inline-block px-3 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-full text-xs font-medium">' + getTerm('done') + '</span>';

            panel.innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center gap-2 flex-wrap">
                        ${statusBadge ? statusBadge : ''}
                        ${task.readableId ? `<span class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full text-xs font-mono font-semibold">${task.readableId}</span>` : ''}
                    </div>
                    <h2 class="text-2xl font-semibold">${esc(task.content)}</h2>

                    ${task.convertedFrom ? `
                        <div class="p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg text-sm">
                            <div class="flex items-start gap-2">
                                <span class="text-blue-600 dark:text-blue-400">üîÑ</span>
                                <div class="flex-1">
                                    <div class="font-semibold text-blue-900 dark:text-blue-300">Converted from ${task.convertedFrom.type.toUpperCase()}</div>
                                    <div class="text-blue-700 dark:text-blue-400 mt-1">
                                        <span class="font-mono text-xs">${task.convertedFrom.readableId}</span> ‚Ä¢ ${esc(task.convertedFrom.reason)}
                                    </div>
                                    <div class="text-xs text-blue-600 dark:text-blue-500 mt-1">${new Date(task.convertedFrom.convertedAt).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="space-y-2 text-sm">
                        ${task.dueDate ? `
                            <div class="flex items-center gap-2 text-gray-600 dark:text-gray-400">
                                <span>üìÖ</span>
                                <span>Due: ${task.dueDate}</span>
                            </div>
                        ` : ''}
                        ${task.delegatedTo ? `
                            <div class="flex items-center gap-2 text-purple-600 dark:text-purple-400">
                                <span>üë§</span>
                                <span>Delegated to: <strong>@${esc(task.delegatedTo)}</strong></span>
                            </div>
                        ` : ''}
                        ${task.waitingOn ? `
                            <div class="flex items-center gap-2 text-yellow-600 dark:text-yellow-400">
                                <span>‚è∏</span>
                                <span>Waiting on: <strong>${esc(task.waitingOn)}</strong></span>
                            </div>
                        ` : ''}
                        <div class="flex items-center gap-2 text-gray-500">
                            <span>üïí</span>
                            <span>Created: ${new Date(task.createdAt).toLocaleDateString()}</span>
                        </div>
                        ${(() => {
                            const priorityInfo = getPriorityDisplay(task.priority);
                            return `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 ${priorityInfo.color}">
                                        <span>${priorityInfo.icon}</span>
                                        <span>Priority: <strong>${priorityInfo.label}</strong></span>
                                    </div>
                                    <button onclick="cyclePriority('${task.id}')" class="px-2 py-1 text-xs ${priorityInfo.bg} ${priorityInfo.color} hover:opacity-80 rounded" title="Click to cycle priority">
                                        Change
                                    </button>
                                </div>
                            `;
                        })()}
                    </div>

${getRaidDetailsSection(task)}

                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold">Notes</h3>
                            ${state.editingTaskId === task.id && state.editingField === 'notes' ? '' : `
                                <button onclick="event.stopPropagation(); startEditingNotes('${task.id}')" class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded" title="Edit notes">
                                    ‚úèÔ∏è Edit
                                </button>
                            `}
                        </div>
                        ${state.editingTaskId === task.id && state.editingField === 'notes' ? `
                            <textarea
                                id="notesTextarea"
                                class="w-full px-3 py-2 bg-white dark:bg-gray-900 border border-blue-500 focus:ring-2 focus:ring-blue-500 rounded resize-none"
                                rows="5"
                                placeholder="Add notes, details, or context for this task..."
                                onblur="finishEditingNotes('${task.id}', this.value)"
                                onkeydown="if(event.key==='Escape') { cancelEditing(); } else if(event.key==='Enter' && (event.ctrlKey || event.metaKey)) { finishEditingNotes('${task.id}', this.value); }"
                            >${esc(task.notes || '')}</textarea>
                            <p class="mt-1 text-xs text-gray-500">Press Ctrl/Cmd+Enter to save, Esc to cancel</p>
                        ` : `
                            <div
                                class="text-sm text-gray-600 dark:text-gray-400 cursor-text hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded min-h-[60px] whitespace-pre-wrap"
                                ondblclick="event.stopPropagation(); startEditingNotes('${task.id}')"
                                title="Double-click to edit notes"
                            >${task.notes ? esc(task.notes) : '<span class="italic text-gray-400">No notes yet. Double-click to add notes...</span>'}</div>
                        `}
                    </div>

                    ${(() => {
                        const links = getLinkedTasks(task.id);
                        const backlinks = getBacklinks(task.id);

                        if (links.length === 0 && backlinks.length === 0) return '';

                        return `
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold">Links</h3>
                                    <button onclick="startLinking('${task.id}')" class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900 rounded" title="Link to another task">
                                        + Link
                                    </button>
                                </div>
                                ${links.length > 0 ? `
                                    <div class="space-y-2 mb-3">
                                        ${links.map(link => {
                                            const linkInfo = LINK_TYPES[link.type];
                                            return `
                                                <div class="flex items-start gap-2 text-sm group">
                                                    <span class="text-xs">${linkInfo.icon}</span>
                                                    <div class="flex-1 min-w-0">
                                                        <span class="text-gray-500 dark:text-gray-400 text-xs">${linkInfo.label}:</span>
                                                        <button onclick="jumpToTask('${link.taskId}')" class="block text-blue-600 dark:text-blue-400 hover:underline truncate text-left">${esc(link.task.content)}</button>
                                                    </div>
                                                    <button onclick="removeLink('${task.id}', '${link.taskId}'); render();" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 text-xs" title="Remove link">√ó</button>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                                ${backlinks.length > 0 ? `
                                    <div class="space-y-2">
                                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold">Linked from:</p>
                                        ${backlinks.map(bl => {
                                            const linkInfo = LINK_TYPES[bl.type];
                                            return `
                                                <div class="flex items-start gap-2 text-sm">
                                                    <span class="text-xs">${linkInfo.icon}</span>
                                                    <button onclick="jumpToTask('${bl.task.id}')" class="flex-1 text-blue-600 dark:text-blue-400 hover:underline truncate text-left">${esc(bl.task.content)}</button>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    })()}

                    ${!task.archived && task.type && task.type !== 'task' ? `
                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h3 class="text-sm font-semibold mb-2">RAID Lifecycle</h3>
                            <div class="flex gap-2 flex-wrap">
                                ${task.type === 'assumption' ? `
                                    <button onclick="convertToRisk('${task.id}')" class="px-3 py-1 text-xs bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-950/50 rounded border border-red-200 dark:border-red-800">
                                        ‚ö†Ô∏è Convert to Risk
                                    </button>
                                ` : ''}
                                ${task.type === 'risk' ? `
                                    <button onclick="convertToIssue('${task.id}')" class="px-3 py-1 text-xs bg-orange-50 dark:bg-orange-950/30 text-orange-700 dark:text-orange-300 hover:bg-orange-100 dark:hover:bg-orange-950/50 rounded border border-orange-200 dark:border-orange-800">
                                        üö® Convert to Issue
                                    </button>
                                ` : ''}
                                ${(task.type === 'issue' || task.type === 'risk') ? `
                                    <button onclick="convertToDependency('${task.id}')" class="px-3 py-1 text-xs bg-purple-50 dark:bg-purple-950/30 text-purple-700 dark:text-purple-300 hover:bg-purple-100 dark:hover:bg-purple-950/50 rounded border border-purple-200 dark:border-purple-800">
                                        üîó Convert to Dependency
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${!task.archived && (task.delegatedTo || task.waitingOn || (getLinkedTasks(task.id).length === 0 && getBacklinks(task.id).length === 0)) ? `
                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h3 class="text-sm font-semibold mb-2">Actions</h3>
                            <div class="flex gap-2 flex-wrap">
                                ${task.archived ? `
                                    <button onclick="unarchiveTask('${task.id}')" class="px-3 py-1 text-xs bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900 rounded">
                                        Unarchive
                                    </button>
                                ` : ''}
                                ${task.delegatedTo ? `
                                    <button onclick="updateTask('${task.id}', { delegatedTo: null, status: 'active' })" class="px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                                        Reclaim from @${esc(task.delegatedTo)}
                                    </button>
                                ` : ''}
                                ${task.waitingOn ? `
                                    <button onclick="updateTask('${task.id}', { waitingOn: null, status: 'active' })" class="px-3 py-1 text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                                        Clear blocker
                                    </button>
                                ` : ''}
                                ${getLinkedTasks(task.id).length === 0 && getBacklinks(task.id).length === 0 ? `
                                    <button onclick="startLinking('${task.id}')" class="px-3 py-1 text-xs bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900 rounded">
                                        üîó Link to task
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-400">
                        <p><strong>Tip:</strong> Double-click any field to edit. Press <kbd class="px-1 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs">s</kbd> to cycle status.</p>
                    </div>
                </div>
            `;
        }

        function toggleKeyboardHelp() {
            state.showKeyboardHelp = !state.showKeyboardHelp;
            const helpDiv = document.getElementById('keyboardHelp');
            if (state.showKeyboardHelp) {
                helpDiv.classList.remove('hidden');
            } else {
                helpDiv.classList.add('hidden');
            }
        }

        // New Navigation Functions
        function toggleHamburgerMenu() {
            state.hamburgerMenuOpen = !state.hamburgerMenuOpen;
            const menu = document.getElementById('hamburgerMenu');
            const drawer = document.getElementById('hamburgerDrawer');

            if (state.hamburgerMenuOpen) {
                menu.classList.remove('hidden');
                setTimeout(() => {
                    drawer.style.transform = 'translateX(0)';
                }, 10);
                // Populate projects in hamburger
                updateHamburgerProjects();
            } else {
                drawer.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    menu.classList.add('hidden');
                }, 300);
            }
        }

        function toggleFabMenu() {
            state.fabMenuOpen = !state.fabMenuOpen;
            const fabMenu = document.getElementById('fabMenu');
            const fab = document.getElementById('fab');

            if (state.fabMenuOpen) {
                fabMenu.classList.remove('hidden');
                fab.style.transform = 'rotate(45deg)';
            } else {
                fabMenu.classList.add('hidden');
                fab.style.transform = 'rotate(0deg)';
            }
        }

        function setBottomNavView(view) {
            state.bottomNavView = view;

            // Update bottom nav button states
            const buttons = document.querySelectorAll('#bottomNav button');
            buttons.forEach(btn => {
                if (btn.dataset.nav === view) {
                    btn.classList.remove('text-gray-600', 'dark:text-gray-400');
                    btn.classList.add('text-blue-600', 'dark:text-blue-400');
                } else {
                    btn.classList.remove('text-blue-600', 'dark:text-blue-400');
                    btn.classList.add('text-gray-600', 'dark:text-gray-400');
                }
            });

            // Update view based on bottom nav selection
            switch(view) {
                case 'all':
                    state.viewFilter = 'all';
                    state.showMatrixView = false;
                    state.showRaidView = false;
                    state.showArchived = false;
                    break;
                case 'active':
                    state.viewFilter = 'active';
                    state.showMatrixView = false;
                    state.showRaidView = false;
                    state.showArchived = false;
                    break;
                case 'matrix':
                    state.showMatrixView = true;
                    state.showRaidView = false;
                    state.showArchived = false;
                    break;
                case 'more':
                    // More tab doesn't change view, just indicates menu is available
                    break;
            }

            render();
        }

        function setView(viewName) {
            switch(viewName) {
                case 'tasks':
                    state.showMatrixView = false;
                    state.showRaidView = false;
                    state.viewFilter = 'all';
                    setBottomNavView('all');
                    break;
                case 'matrix':
                    state.showMatrixView = true;
                    state.showRaidView = false;
                    setBottomNavView('matrix');
                    break;
                case 'raid':
                    state.showMatrixView = false;
                    state.showRaidView = true;
                    break;
            }
            render();
        }

        function toggleArchived() {
            state.showArchived = !state.showArchived;
            render();
        }

        function createTaskWithType(type) {
            state.newTaskType = type;
            // Focus on creating a new task
            const newTaskInput = document.getElementById('newTaskInput');
            if (newTaskInput) {
                newTaskInput.focus();
            }
        }

        function toggleProjectSelector() {
            state.projectSelectorOpen = !state.projectSelectorOpen;
            // TODO: Show project selector modal
        }

        function toggleMobileSettings() {
            state.mobileSettingsOpen = !state.mobileSettingsOpen;
            // TODO: Show mobile settings modal
        }

        function switchProject(projectId) {
            state.currentProject = projectId;

            // Update mobile header project name
            const currentProjectName = document.getElementById('currentProjectName');
            if (currentProjectName && state.projects[projectId]) {
                currentProjectName.textContent = state.projects[projectId].name;
            }

            save();
            render();
        }

        function updateHamburgerProjects() {
            const container = document.getElementById('hamburgerProjectList');
            if (!container) return;

            const projects = Object.values(state.projects);
            container.innerHTML = projects.map(proj => `
                <button onclick="switchProject('${proj.id}'); toggleHamburgerMenu()"
                        class="w-full px-3 py-2 text-left text-sm rounded-lg ${proj.id === state.currentProject ? 'bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}">
                    ${proj.name}
                </button>
            `).join('');

            // Update archived count in hamburger
            const archivedCount = Object.values(state.projects[state.currentProject]?.tasks || {})
                .filter(t => t.archived).length;
            const hamburgerArchivedCount = document.getElementById('hamburgerArchivedCount');
            if (hamburgerArchivedCount) {
                hamburgerArchivedCount.textContent = archivedCount;
            }
        }

        function setBottomSheetState(newState) {
            const isMobile = window.innerWidth < 768;
            if (!isMobile) return;
            state.bottomSheetState = newState;
            const container = document.getElementById('detailsPanelContainer');
            const backdrop = document.getElementById('detailsBackdrop');
            if (newState === 'collapsed') {
                container.style.height = '60vh';
                container.style.transform = 'translateY(100%)';
                backdrop.style.opacity = '0';
                backdrop.style.pointerEvents = 'none';
            } else if (newState === 'half') {
                container.style.height = '60vh';
                container.style.transform = 'translateY(0)';
                backdrop.style.opacity = '0.5';
                backdrop.style.pointerEvents = 'auto';
            } else if (newState === 'full') {
                container.style.height = '100vh';
                container.style.transform = 'translateY(0)';
                backdrop.style.opacity = '0.5';
                backdrop.style.pointerEvents = 'auto';
            }
        }

        function closeBottomSheet() {
            setBottomSheetState('collapsed');
            state.detailsExpanded = false;
        }

        function openBottomSheetToHalf() {
            setBottomSheetState('half');
            state.detailsExpanded = true;
        }

        function openBottomSheetToFull() {
            setBottomSheetState('full');
            state.detailsExpanded = true;
        }

        function toggleDetails() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                if (state.bottomSheetState === 'collapsed') {
                    openBottomSheetToHalf();
                } else if (state.bottomSheetState === 'half') {
                    openBottomSheetToFull();
                } else {
                    closeBottomSheet();
                }
                return;
            }
            state.detailsExpanded = !state.detailsExpanded;
            const container = document.getElementById('detailsPanelContainer');
            const toggle = document.getElementById('detailsToggle');
            const mainContent = document.getElementById('mainContent');
            const floatingToggle = document.getElementById('floatingDetailsToggle');

            if (state.detailsExpanded) {
                container.style.transform = 'translateX(0)';
                toggle.textContent = '‚ñ∂';
                mainContent.style.marginRight = '30%';
                floatingToggle.classList.add('hidden');
            } else {
                container.style.transform = 'translateX(100%)';
                toggle.textContent = '‚óÄ';
                mainContent.style.marginRight = '0';
                floatingToggle.classList.remove('hidden');
            }
        }

        function initBottomSheetDrag() {
            const handle = document.getElementById('bottomSheetHandle');
            const container = document.getElementById('detailsPanelContainer');
            let startY = 0;
            let startHeight = 0;
            let isDragging = false;

            function onTouchStart(e) {
                const isMobile = window.innerWidth < 768;
                if (!isMobile || state.bottomSheetState === 'collapsed') return;
                isDragging = true;
                startY = e.touches[0].clientY;
                startHeight = container.offsetHeight;
                state.bottomSheetDragging = true;
                container.style.transition = 'none';
            }

            function onTouchMove(e) {
                if (!isDragging) return;
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                const newHeight = startHeight - deltaY;
                const windowHeight = window.innerHeight;
                const clampedHeight = Math.max(0, Math.min(windowHeight, newHeight));
                container.style.height = `${clampedHeight}px`;
                const backdrop = document.getElementById('detailsBackdrop');
                const opacity = Math.min(0.5, (clampedHeight / windowHeight) * 0.5);
                backdrop.style.opacity = opacity.toString();
                e.preventDefault();
            }

            function onTouchEnd(e) {
                if (!isDragging) return;
                isDragging = false;
                state.bottomSheetDragging = false;
                container.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                const finalHeight = container.offsetHeight;
                const windowHeight = window.innerHeight;
                const heightPercent = (finalHeight / windowHeight) * 100;
                if (heightPercent < 30) {
                    closeBottomSheet();
                } else if (heightPercent < 80) {
                    setBottomSheetState('half');
                } else {
                    setBottomSheetState('full');
                }
            }

            handle.addEventListener('touchstart', onTouchStart, { passive: false });
            handle.addEventListener('touchmove', onTouchMove, { passive: false });
            handle.addEventListener('touchend', onTouchEnd, { passive: true });

            handle.addEventListener('mousedown', (e) => {
                const isMobile = window.innerWidth < 768;
                if (!isMobile || state.bottomSheetState === 'collapsed') return;
                isDragging = true;
                startY = e.clientY;
                startHeight = container.offsetHeight;
                container.style.transition = 'none';

                const onMouseMove = (e) => {
                    if (!isDragging) return;
                    const currentY = e.clientY;
                    const deltaY = currentY - startY;
                    const newHeight = startHeight - deltaY;
                    const windowHeight = window.innerHeight;
                    const clampedHeight = Math.max(0, Math.min(windowHeight, newHeight));
                    container.style.height = `${clampedHeight}px`;
                    const backdrop = document.getElementById('detailsBackdrop');
                    const opacity = Math.min(0.5, (clampedHeight / windowHeight) * 0.5);
                    backdrop.style.opacity = opacity.toString();
                };

                const onMouseUp = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    container.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    const finalHeight = container.offsetHeight;
                    const windowHeight = window.innerHeight;
                    const heightPercent = (finalHeight / windowHeight) * 100;
                    if (heightPercent < 30) {
                        closeBottomSheet();
                    } else if (heightPercent < 80) {
                        setBottomSheetState('half');
                    } else {
                        setBottomSheetState('full');
                    }
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function startLinking(taskId) {
            state.linkingMode = true;
            state.linkingSourceId = taskId;
            state.linkingType = 'relates-to';
            state.searchQuery = '';
            render();
            renderLinkOverlay();
        }

        function completeLinking(targetTaskId) {
            if (!state.linkingSourceId || !targetTaskId) return;
            if (state.linkingSourceId === targetTaskId) {
                alert('Cannot link a task to itself');
                return;
            }

            addLink(state.linkingSourceId, targetTaskId, state.linkingType);
            state.linkingMode = false;
            state.linkingSourceId = null;
            render();
        }

        function cancelLinking() {
            state.linkingMode = false;
            state.linkingSourceId = null;
            state.searchQuery = '';
            document.getElementById('linkOverlay').classList.add('hidden');
        }

        function setLinkType(type) {
            state.linkingType = type;
            renderLinkOverlay();
        }

        function filterLinkTasks(query) {
            state.searchQuery = query.toLowerCase();
            renderLinkTaskList();
        }

        function renderLinkOverlay() {
            const overlay = document.getElementById('linkOverlay');
            if (!state.linkingMode) {
                overlay.classList.add('hidden');
                return;
            }

            overlay.classList.remove('hidden');

            // Render link type selector
            const typeSelector = document.getElementById('linkTypeSelector');
            typeSelector.innerHTML = Object.entries(LINK_TYPES).map(([type, info]) => {
                const isSelected = state.linkingType === type;
                return `
                    <button
                        onclick="setLinkType('${type}')"
                        class="px-3 py-1.5 text-xs rounded-lg border ${
                            isSelected
                                ? 'bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 border-blue-500 font-medium'
                                : 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 hover:border-blue-400'
                        }"
                        title="${info.label}"
                    >
                        ${info.icon} ${info.label}
                    </button>
                `;
            }).join('');

            renderLinkTaskList();

            // Focus search input
            setTimeout(() => {
                document.getElementById('linkSearchInput').focus();
            }, 100);
        }

        function renderLinkTaskList() {
            const container = document.getElementById('linkTaskList');
            const allTasks = getProject().tasks.filter(t => !t.archived && t.id !== state.linkingSourceId);

            let filteredTasks = allTasks;
            if (state.searchQuery) {
                filteredTasks = allTasks.filter(t =>
                    t.content.toLowerCase().includes(state.searchQuery)
                );
            }

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No tasks found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredTasks.map(task => {
                const statusInfo = SYMBOLS[task.status];
                return `
                    <button
                        onclick="completeLinking('${task.id}')"
                        class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 border border-transparent hover:border-blue-500 mb-2 transition-colors"
                    >
                        <div class="flex items-start gap-3">
                            <span class="text-blue-600 dark:text-blue-400 font-mono text-lg">${statusInfo}</span>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium truncate">${esc(task.content)}</p>
                                <div class="flex items-center gap-3 mt-1 text-xs text-gray-500 dark:text-gray-400">
                                    ${task.dueDate ? `<span>üìÖ ${task.dueDate}</span>` : ''}
                                    ${task.delegatedTo ? `<span>‚Üí @${esc(task.delegatedTo)}</span>` : ''}
                                    ${task.waitingOn ? `<span>‚è∏ ${esc(task.waitingOn)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </button>
                `;
            }).join('');
        }

        function jumpToTask(taskId) {
            const allTasks = getProject().tasks;
            const visibleTasks = getTasks();
            const targetIndex = visibleTasks.findIndex(t => t.id === taskId);

            if (targetIndex >= 0) {
                state.selectedIndex = targetIndex;
                render();
            } else {
                // Task might be filtered out - clear filter and try again
                state.viewFilter = 'all';
                state.showArchived = allTasks.find(t => t.id === taskId)?.archived || false;
                render();

                const newVisibleTasks = getTasks();
                const newTargetIndex = newVisibleTasks.findIndex(t => t.id === taskId);
                if (newTargetIndex >= 0) {
                    state.selectedIndex = newTargetIndex;
                    render();
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Undo/Redo (Ctrl/Cmd+Z, Ctrl/Cmd+Shift+Z or Ctrl/Cmd+Y)
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
                return;
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                redo();
                return;
            }

            // Cancel linking mode with Escape
            if (e.key === 'Escape' && state.linkingMode) {
                e.preventDefault();
                cancelLinking();
                return;
            }

            // Show help with "?"
            if (e.key === '?' && !state.showKeyboardHelp && !state.linkingMode) {
                e.preventDefault();
                toggleKeyboardHelp();
                return;
            }

            // Close help with Escape
            if (e.key === 'Escape' && state.showKeyboardHelp) {
                e.preventDefault();
                toggleKeyboardHelp();
                return;
            }

            // Allow typing in inputs
            if (e.target.tagName === 'INPUT' && e.target.id !== 'newTaskInput' && e.target.id !== 'linkSearchInput') {
                if (e.key === 'Escape') {
                    cancelEditing();
                }
                return;
            }

            const tasks = getTasks();

            if (e.key === 'j' || e.key === 'ArrowDown') {
                e.preventDefault();
                state.selectedIndex = Math.min(state.selectedIndex + 1, tasks.length - 1);
                render();
            }

            if (e.key === 'k' || e.key === 'ArrowUp') {
                e.preventDefault();
                state.selectedIndex = Math.max(state.selectedIndex - 1, 0);
                render();
            }

            if (e.key === 'n') {
                e.preventDefault();
                document.getElementById('newTaskInput')?.focus();
            }

            if (e.key === 'd') {
                e.preventDefault();
                const task = tasks[state.selectedIndex];
                if (task) toggleSelectedDone();
            }

            if (e.key === 's') {
                e.preventDefault();
                const task = tasks[state.selectedIndex];
                if (task) cycleSelectedStatus();
            }

            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelectedTask();
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                editSelectedTask();
            }

            if (e.key === 'Escape') {
                e.preventDefault();
                state.selectedIndex = -1;
                render();
            }
        });

        // Event listeners
        document.getElementById('terminologyToggle').onclick = () => {
            state.terminology = state.terminology === 'dashPlus' ? 'fiveD' : 'dashPlus';
            document.getElementById('termLabel').textContent = state.terminology === 'dashPlus' ? '-+' : '5D';
            localStorage.setItem('terminology', state.terminology);
            render();
        };

        document.getElementById('taskViewToggle').onclick = () => {
            state.showMatrixView = false;
            state.showRaidView = false;

            const taskBtn = document.getElementById('taskViewToggle');
            const matrixBtn = document.getElementById('matrixViewToggle');
            const raidBtn = document.getElementById('raidViewToggle');

            taskBtn.classList.add('bg-blue-100', 'dark:bg-blue-950');
            matrixBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
            raidBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');

            render();
        };

        document.getElementById('matrixViewToggle').onclick = () => {
            state.showMatrixView = !state.showMatrixView;
            if (state.showMatrixView) state.showRaidView = false;

            const taskBtn = document.getElementById('taskViewToggle');
            const matrixBtn = document.getElementById('matrixViewToggle');
            const raidBtn = document.getElementById('raidViewToggle');

            if (state.showMatrixView) {
                taskBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
                matrixBtn.classList.add('bg-blue-100', 'dark:bg-blue-950');
                raidBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
            } else {
                taskBtn.classList.add('bg-blue-100', 'dark:bg-blue-950');
                matrixBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
            }

            render();
        };

        document.getElementById('raidViewToggle').onclick = () => {
            state.showRaidView = !state.showRaidView;
            if (state.showRaidView) state.showMatrixView = false;

            const taskBtn = document.getElementById('taskViewToggle');
            const matrixBtn = document.getElementById('matrixViewToggle');
            const raidBtn = document.getElementById('raidViewToggle');

            if (state.showRaidView) {
                taskBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
                matrixBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
                raidBtn.classList.add('bg-blue-100', 'dark:bg-blue-950');
            } else {
                taskBtn.classList.add('bg-blue-100', 'dark:bg-blue-950');
                raidBtn.classList.remove('bg-blue-100', 'dark:bg-blue-950');
            }

            render();
        };

        document.getElementById('archivedToggle').onclick = () => {
            state.showArchived = !state.showArchived;
            const btn = document.getElementById('archivedToggle');
            btn.classList.toggle('bg-blue-100', state.showArchived);
            btn.classList.toggle('dark:bg-blue-950', state.showArchived);
            render();
        };

        document.getElementById('themeToggle').onclick = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        };

        // Sidebar toggles
        const sidebarTerminologyToggle = document.getElementById('sidebarTerminologyToggle');
        if (sidebarTerminologyToggle) {
            sidebarTerminologyToggle.onclick = () => {
                state.terminology = state.terminology === 'dashPlus' ? 'fiveD' : 'dashPlus';
                document.getElementById('termLabel').textContent = state.terminology === 'dashPlus' ? '-+' : '5D';
                localStorage.setItem('terminology', state.terminology);
                render();
            };
        }

        const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
        if (sidebarThemeToggle) {
            sidebarThemeToggle.onclick = () => {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            };
        }

        document.getElementById('newProjectBtn').onclick = () => {
            const pid = id();
            state.projects[pid] = { name: 'New Project', tasks: [] };
            state.currentProject = pid;
            state.editingProjectId = pid;
            save();
            render();
        };

        // Touch gesture handlers for mobile swipe actions
        function handleTouchStart(event, taskId) {
            // Only on mobile
            if (window.innerWidth >= 768) return;

            const touch = event.touches[0];
            state.touchStartX = touch.clientX;
            state.touchStartY = touch.clientY;
            state.touchStartTime = Date.now();
            state.swipingTaskId = taskId;
            state.swipeDirection = null;

            const row = event.currentTarget;
            row.classList.add('swiping');
        }

        function handleTouchMove(event, taskId) {
            // Only on mobile
            if (window.innerWidth >= 768) return;
            if (!state.swipingTaskId) return;

            const touch = event.touches[0];
            const deltaX = touch.clientX - state.touchStartX;
            const deltaY = touch.clientY - state.touchStartY;

            // Determine if horizontal swipe (not vertical scroll)
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                event.preventDefault(); // Prevent scrolling

                const row = document.querySelector(`[data-task-id="${state.swipingTaskId}"]`);
                if (!row) return;

                // Apply transform to the row
                row.style.transform = `translateX(${deltaX}px)`;

                // Show appropriate action buttons based on swipe direction
                if (deltaX < -50) {
                    // Swipe left - show right-side actions
                    state.swipeDirection = 'left';
                    showSwipeActions(state.swipingTaskId, 'right');
                } else if (deltaX > 50) {
                    // Swipe right - show left-side action
                    state.swipeDirection = 'right';
                    showSwipeActions(state.swipingTaskId, 'left');
                } else {
                    state.swipeDirection = null;
                    hideSwipeActions(state.swipingTaskId);
                }
            }
        }

        function handleTouchEnd(event, taskId) {
            // Only on mobile
            if (window.innerWidth >= 768) return;
            if (!state.swipingTaskId) return;

            const touch = event.changedTouches[0];
            const deltaX = touch.clientX - state.touchStartX;
            const deltaY = touch.clientY - state.touchStartY;
            const deltaTime = Date.now() - state.touchStartTime;

            const row = document.querySelector(`[data-task-id="${state.swipingTaskId}"]`);
            if (!row) return;

            row.classList.remove('swiping');

            // Check if this was a swipe or a tap
            const isSwipe = Math.abs(deltaX) > 50 && deltaTime < 300;

            if (isSwipe) {
                if (deltaX < -50) {
                    // Swipe left - keep actions visible
                    row.style.transform = 'translateX(-180px)';
                    // Haptic feedback
                    if (navigator.vibrate) navigator.vibrate(10);
                } else if (deltaX > 50) {
                    // Swipe right - cycle status
                    cycleStatus(taskId);
                    row.style.transform = 'translateX(0)';
                    hideSwipeActions(taskId);
                    // Haptic feedback
                    if (navigator.vibrate) navigator.vibrate(10);
                }
            } else {
                // Not a swipe - reset position
                row.style.transform = 'translateX(0)';
                hideSwipeActions(taskId);

                // If it was a quick tap, select the task
                if (Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10 && deltaTime < 200) {
                    selectTaskByClick(row);
                }
            }

            state.swipingTaskId = null;
            state.swipeDirection = null;
        }

        function showSwipeActions(taskId, side) {
            // Check if actions already exist
            let actionsContainer = document.getElementById(`swipe-actions-${taskId}-${side}`);
            if (actionsContainer) {
                actionsContainer.style.display = 'flex';
                return;
            }

            // Create action buttons
            const row = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!row) return;

            const wrapper = row.parentElement;
            if (!wrapper || !wrapper.classList.contains('task-row-wrapper')) return;

            actionsContainer = document.createElement('div');
            actionsContainer.id = `swipe-actions-${taskId}-${side}`;
            actionsContainer.className = `swipe-actions swipe-actions-${side}`;

            if (side === 'right') {
                // Right-side actions (swipe left to reveal)
                actionsContainer.innerHTML = `
                    <button class="swipe-action swipe-action-done" onclick="event.stopPropagation(); toggleDone('${taskId}'); resetSwipe('${taskId}');">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Done</span>
                    </button>
                    <button class="swipe-action swipe-action-delete" onclick="event.stopPropagation(); if(confirm('Archive this task?')) { archiveTask('${taskId}'); resetSwipe('${taskId}'); }">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span>Delete</span>
                    </button>
                    <button class="swipe-action swipe-action-more" onclick="event.stopPropagation(); selectTaskById('${taskId}'); resetSwipe('${taskId}');">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                        </svg>
                        <span>More</span>
                    </button>
                `;
            } else {
                // Left-side action (swipe right to reveal)
                actionsContainer.innerHTML = `
                    <button class="swipe-action swipe-action-status">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Cycle Status</span>
                    </button>
                `;
            }

            wrapper.appendChild(actionsContainer);
        }

        function hideSwipeActions(taskId) {
            ['left', 'right'].forEach(side => {
                const actionsContainer = document.getElementById(`swipe-actions-${taskId}-${side}`);
                if (actionsContainer) {
                    actionsContainer.style.display = 'none';
                }
            });
        }

        function resetSwipe(taskId) {
            const row = document.querySelector(`[data-task-id="${taskId}"]`);
            if (row) {
                row.style.transform = 'translateX(0)';
                hideSwipeActions(taskId);
            }
        }

        function selectTaskByClick(row) {
            const index = parseInt(row.dataset.taskIndex);
            if (!isNaN(index)) {
                state.selectedIndex = index;
                render();
            }
        }

        function selectTaskById(taskId) {
            const tasks = getFilteredTasks();
            const index = tasks.findIndex(t => t.id === taskId);
            if (index !== -1) {
                state.selectedIndex = index;
                render();
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
            const savedTerm = localStorage.getItem('terminology');
            if (savedTerm) {
                state.terminology = savedTerm;
                document.getElementById('termLabel').textContent = savedTerm === 'dashPlus' ? '-+' : '5D';
            }
            load();
            render();
            initBottomSheetDrag();

            document.addEventListener('focusin', (e) => {
                const isMobile = window.innerWidth < 768;
                const detailsPanel = document.getElementById('detailsPanelContainer');
                const isInDetailsPanel = detailsPanel && detailsPanel.contains(e.target);
                if (isMobile && isInDetailsPanel && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
                    if (state.bottomSheetState === 'half') {
                        openBottomSheetToFull();
                    }
                }
            });
        });
    </script>
</body>
</html>
